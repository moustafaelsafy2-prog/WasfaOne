<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>مجلة الوصفة الذكية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&family=Inter:wght@100..900&display=swap');
    :root{ --ink:#0f172a; --muted:#475569; --brand:#ef4444; --soft:#f7f7f9; --line:#e5e7eb; }
    *{box-sizing:border-box}
    body{font-family:'Cairo','Inter',sans-serif;background:var(--soft);color:var(--ink);min-height:100vh;overflow-x:hidden}
    .wrap{max-width:1080px;margin-inline:auto}
    .card{background:linear-gradient(180deg,#fff,#fafafa);border:1px solid var(--line);border-radius:22px;padding:22px;box-shadow:0 20px 40px rgba(0,0,0,.06)}
    .divider{height:1px;background:var(--line);margin:18px 0}
    .area{display:grid;grid-template-columns: .8fr 1.2fr;gap:28px;align-items:start}
    @media (max-width:1024px){ .area{grid-template-columns:1fr} }
    .meta{display:flex;gap:14px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;font-weight:700}
    .chip svg{width:16px;height:16px;color:var(--brand)}
    .panel{position:sticky;top:16px;background:#fff;border:1px solid var(--line);border-radius:18px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.04)}
    .panel h3{font-size:1.25rem;font-weight:900;margin-bottom:10px}
    .ingredient-list li{position:relative;padding-right:1.25rem;line-height:1.9;margin-bottom:.4rem}
    .ingredient-list li::before{content:'•';position:absolute;right:0;color:var(--brand);font-weight:900}
    .steps-list{counter-reset:step}
    .step{position:relative;background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px 100px 18px 24px;box-shadow:0 8px 20px rgba(0,0,0,.04);margin-bottom:14px}
    .step::before{
      counter-increment:step; content:"خطوة " counter(step);
      position:absolute; right:16px; top:16px; min-width:56px; height:32px; border-radius:999px;
      display:inline-grid; place-items:center; padding:0 10px;
      color:#fff; background:var(--brand); font-weight:900; box-shadow:0 2px 6px rgba(239,68,68,.35)
    }
    .step p{margin:0;color:var(--muted);line-height:1.95}
    .tl-wrap{display:flex;gap:8px;flex-wrap:wrap}
    .tl-pill{flex:1 1 120px;border-radius:14px;padding:10px;border:2px solid #111;color:#111;text-align:center;background:#fff}
    .tl-pill .name{display:block;font-weight:800;font-size:14px}
    .tl-pill .grams{display:block;font-weight:900;font-size:18px;margin-top:4px}
    .tl-pill .flag{display:inline-block;margin-top:6px;padding:2px 8px;border-radius:999px;font-weight:800;font-size:12px;background:#fff}
    .tl-low{background:#e7f7e7;border-color:#0f5132}
    .tl-med{background:#fff7e6;border-color:#b45309}
    .tl-high{background:#ffecec;border-color:#b91c1c}
    .toast{position:fixed;inset-inline-start:16px;inset-block-start:16px;z-index:50}
    .toast-item{background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    .toast-item.success{background:#065f46}.toast-item.error{background:#991b1b}.toast-item.info{background:#111827}
    .loader{border-top-color:var(--brand);animation:spin 1.2s linear infinite;border:2px dashed;width:20px;height:20px;border-radius:999px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .banner{border:1px dashed #b45309;background:#fff7e6;color:#92400e}
    .banner.red{border-color:#b91c1c;background:#ffecec;color:#7f1d1d}
    select,input[type="number"],input[type="text"]{min-height:48px}
  </style>
</head>
<body class="p-4 md:p-8">
  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <div class="wrap">
    <!-- Header + Logout -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-4xl md:text-5xl font-black">مجلة الوصفة الذكية</h1>
      <button id="logoutBtn" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-sm font-bold">
        تسجيل الخروج
      </button>
    </div>

    <!-- Form -->
    <div class="card mb-8">
      <p class="text-center text-[var(--muted)] mt-2 mb-4">تنسيق مجلة — إشارات ضوئية للتغذية فقط — بدون صور.</p>
      <div class="divider"></div>
      <!-- باقي الفورم كما هو ... -->
    </div>

    <section id="contentArea" class="area mt-8 hidden">
      <aside class="panel">
        <h3>المكونات</h3>
        <ul id="ingredientsList" class="ingredient-list"></ul>
      </aside>
      <main>
        <h3 class="text-2xl font-black mb-3">طريقة التحضير</h3>
        <div id="preparationSteps" class="steps-list"></div>
      </main>
    </section>
  </div>

  <script>
    const API_ENDPOINT="/.netlify/functions/generateRecipe";
    const $=id=>document.getElementById(id);

    // زر تسجيل الخروج
    const logoutBtn = $('logoutBtn');
    logoutBtn.addEventListener('click', ()=>{
      localStorage.removeItem("wasfa_session");
      window.location.replace("login.html");
    });

    // باقي الأكواد كما هي (generate, callAPI, ensureSessionOrRedirect ...)
    function ensureSessionOrRedirect(){
      try{
        const sess = JSON.parse(localStorage.getItem("wasfa_session")||"null");
        if(!sess || !sess.auth_token || !sess.session_nonce){
          window.location.replace("login.html");
        }
      }catch(_){ window.location.replace("login.html"); }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      ensureSessionOrRedirect();
      // باقي الأحداث كما في النسخة الأصلية
    });
  </script>
</body>
</html>
