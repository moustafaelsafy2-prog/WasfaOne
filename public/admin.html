<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم — WasfaOne Admin</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts (Inter) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* Custom styles to work with the existing JS */
    body {
        font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji";
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    /* Active state for tab buttons */
    nav.tabs button.active {
      background-color: #ef4444; /* red-500 */
      color: white;
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    }
    
    /* Tab content visibility */
    section.tab {
      display: none;
    }
    section.tab.active {
      display: block;
    }
    
    /* The JS relies on this utility class */
    .hidden {
      display: none;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">

  <!-- Header -->
  <header class="sticky top-0 bg-white/80 backdrop-blur-md border-b border-slate-200 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-5">
      <h1 class="text-2xl font-extrabold text-slate-800">لوحة التحكم — WasfaOne</h1>
      <p class="text-sm text-slate-500 mt-1">أدخل كلمة مرور الأدمن عند الطلب — تُحفظ محليًا (LocalStorage).</p>
      <nav class="tabs mt-4" id="tabs">
        <div class="flex flex-wrap items-center gap-2">
            <button data-tab="tab-users" class="active rounded-full py-2 px-4 text-sm font-semibold text-slate-700 bg-slate-100 hover:bg-slate-200 transition-colors">المستخدمون</button>
            <button data-tab="tab-settings" class="rounded-full py-2 px-4 text-sm font-semibold text-slate-700 bg-slate-100 hover:bg-slate-200 transition-colors">الإعدادات</button>
            <button data-tab="tab-recipes" class="rounded-full py-2 px-4 text-sm font-semibold text-slate-700 bg-slate-100 hover:bg-slate-200 transition-colors">الوصفات</button>
            <button data-tab="tab-logs" class="rounded-full py-2 px-4 text-sm font-semibold text-slate-700 bg-slate-100 hover:bg-slate-200 transition-colors">السجلات</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- ============ Users Tab ============ -->
    <section id="tab-users" class="tab active">
      <div class="space-y-8">
        <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6">
          <h2 class="text-xl font-bold text-slate-800 mb-6">إدارة المستخدمين</h2>

          <!-- Create User Form -->
          <form id="createUserForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-start">
            <!-- Form fields -->
            <div><input required name="name" placeholder="الاسم" class="block w-full rounded-lg border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm" /></div>
            <div><input required name="email" placeholder="البريد الإلكتروني" type="email" class="block w-full rounded-lg border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm" /></div>
            <div><input required name="password" placeholder="كلمة السر" class="block w-full rounded-lg border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm" /></div>
            <div>
              <select name="status" class="block w-full rounded-lg border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                <option value="active">فعّال (Active)</option>
                <option value="suspended">معلّق (Suspended)</option>
              </select>
            </div>
            <div><label class="block text-sm font-medium text-slate-600 mb-1">تاريخ البداية</label><input name="start_date" type="date" class="block w-full rounded-lg border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm" /></div>
            <div><label class="block text-sm font-medium text-slate-600 mb-1">تاريخ النهاية</label><input name="end_date" type="date" class="block w-full rounded-lg border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm" /></div>
            <div class="md:col-span-2 lg:col-span-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pt-2">
                <label class="flex items-center gap-3 text-sm text-slate-600">
                    <input type="checkbox" name="upsert" class="h-4 w-4 rounded border-slate-300 text-red-600 focus:ring-red-500"/>
                    <span>
                        حدِّث المستخدم بدلًا من الإنشاء (إذا كان البريد موجودًا)
                    </span>
                </label>
                <button class="w-full sm:w-auto inline-flex items-center justify-center rounded-lg bg-red-600 py-2.5 px-5 text-sm font-semibold text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all" type="submit">
                    حفظ المستخدم
                </button>
            </div>
          </form>

          <!-- Users Table -->
          <div class="mt-10">
            <p class="text-sm text-slate-500 mb-4">قائمة المستخدمين الحالية</p>
            <div class="overflow-hidden border border-slate-200 rounded-lg">
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                  <thead class="bg-slate-50">
                    <tr>
                      <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">الاسم</th>
                      <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">البريد</th>
                      <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">الحالة</th>
                      <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">البداية</th>
                      <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">النهاية</th>
                      <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">عمليات</th>
                    </tr>
                  </thead>
                  <tbody id="usersTbody" class="divide-y divide-slate-100 bg-white">
                    <!-- JS will populate this -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ Settings Tab ============ -->
    <section id="tab-settings" class="tab">
        <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6">
            <h2 class="text-xl font-bold text-slate-800">الإعدادات العامة</h2>
            <p class="text-sm text-slate-500 mt-1">تحرير <code>data/settings.json</code>: الشعار، بيانات التواصل، الأنظمة الغذائية، الصور، والنص البديل.</p>
            
            <div class="space-y-8 mt-6">
                <!-- Branding -->
                <div>
                    <h3 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-200 pb-3">الهوية (Branding)</h3>
                    <form id="brandingForm" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">الاسم (AR)</label><input name="site_name_ar" class="block w-full rounded-lg border-slate-300" /></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">الاسم (EN)</label><input name="site_name_en" class="block w-full rounded-lg border-slate-300" /></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">رابط الشعار (Logo URL)</label><input name="logo_url" class="block w-full rounded-lg border-slate-300" /></div>
                    </form>
                </div>
                
                <!-- Contact -->
                <div>
                    <h3 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-200 pb-3">التواصل (Contact)</h3>
                    <form id="contactForm" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">رقم الهاتف المعروض</label><input name="phone_display" class="block w-full rounded-lg border-slate-300" /></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">رابط واتساب</label><input name="whatsapp_link" class="block w-full rounded-lg border-slate-300" /></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">البريد</label><input name="email" type="email" class="block w-full rounded-lg border-slate-300" /></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">Instagram</label><input name="instagram" class="block w-full rounded-lg border-slate-300" /></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">TikTok</label><input name="tiktok" class="block w-full rounded-lg border-slate-300" /></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">YouTube</label><input name="youtube" class="block w-full rounded-lg border-slate-300" /></div>
                    </form>
                </div>
                
                <!-- Diet systems -->
                <div>
                    <h3 class="text-lg font-bold text-slate-800 mb-2 border-b border-slate-200 pb-3">الأنظمة الغذائية</h3>
                    <p class="text-sm text-slate-500 mb-4">أضف/عدّل عناصر القائمة (AR/EN + وصف).</p>
                    <div id="dietsList" class="space-y-4"></div>
                    <button id="addDietBtn" class="mt-4 inline-flex items-center rounded-md border border-transparent bg-slate-100 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition-all">+ إضافة نظام غذائي</button>
                </div>

                <!-- Images -->
                <div>
                    <h3 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-200 pb-3">الصور (URLs)</h3>
                    <div id="imagesList" class="space-y-2"></div>
                </div>

                <!-- Images meta (alts) -->
                <div>
                    <h3 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-200 pb-3">النصوص البديلة للصور (Alt)</h3>
                    <div id="imagesMetaList" class="space-y-2"></div>
                </div>
            </div>

            <div class="mt-8 border-t border-slate-200 pt-6">
                <button id="saveSettingsBtn" class="inline-flex items-center justify-center rounded-lg bg-red-600 py-2.5 px-5 text-sm font-semibold text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all">حفظ كل الإعدادات</button>
            </div>
        </div>
    </section>

    <!-- ============ Recipes Tab ============ -->
    <section id="tab-recipes" class="tab">
      <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6">
        <h2 class="text-xl font-bold text-slate-800 mb-2">الوصفات</h2>
        <p class="text-sm text-slate-500">قسم استعراضي — أدرج/أوصل بوظائفك الخاصة إذا كانت متوفّرة.</p>
        <div id="recipesEmpty" class="mt-6 text-center py-10 border-2 border-dashed border-slate-200 rounded-lg">
            <p class="text-slate-500">لا توجد عناصر للعرض حاليًا.</p>
        </div>
      </div>
    </section>

    <!-- ============ Logs Tab ============ -->
    <section id="tab-logs" class="tab">
      <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6">
        <h2 class="text-xl font-bold text-slate-800 mb-2">السجلات</h2>
        <p class="text-sm text-slate-500">لعرض سجلات النظام إن توفّرت واجهة API مناسبة.</p>
        <pre id="logsBox" class="mt-4 whitespace-pre-wrap bg-slate-900 text-slate-200 p-4 rounded-lg text-sm leading-relaxed min-h-[200px]">(لا توجد سجلات)</pre>
      </div>
    </section>
  </main>

  <!-- UNCHANGED JAVASCRIPT LOGIC -->
  <script>
  (function(){
    // ============ Tab switching ============
    const tabsNav = document.getElementById('tabs');
    const tabButtons = Array.from(tabsNav.querySelectorAll('button'));
    const tabSections = Array.from(document.querySelectorAll('section.tab'));
    function activateTab(id){
      tabButtons.forEach(b=> b.classList.toggle('active', b.dataset.tab===id));
      tabSections.forEach(s=> s.classList.toggle('active', s.id===id));
    }
    tabsNav.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-tab]');
      if(!btn) return;
      activateTab(btn.dataset.tab);
    });

    // ============ Admin Key handling ============
    const ADMIN_KEY_STORAGE = 'wasfa_admin_key';
    let ADMIN_KEY = localStorage.getItem(ADMIN_KEY_STORAGE) || '';
    async function promptAdminKey(){
      if(!ADMIN_KEY){
        ADMIN_KEY = prompt('أدخل كلمة مرور الأدمن:');
        if(!ADMIN_KEY) throw new Error('admin_key_required');
        localStorage.setItem(ADMIN_KEY_STORAGE, ADMIN_KEY);
      }
    }

    // ============ Helpers ============
    function el(tag, attrs={}, children=[]) {
      const e = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==='class') e.className = v; else if(k==='text') e.textContent=v; else e.setAttribute(k,v);
      });
      children.forEach(c=> e.appendChild(c));
      return e;
    }
    async function api(path, method='GET', body){
      await promptAdminKey();
      const res = await fetch('/.netlify/functions/' + path, {
        method,
        headers: { 'content-type':'application/json', 'x-admin-key': ADMIN_KEY },
        body: body? JSON.stringify(body): undefined
      });
      if(res.status===401){ localStorage.removeItem(ADMIN_KEY_STORAGE); ADMIN_KEY=''; throw new Error('unauthorized'); }
      let data = {};
      try{ data = await res.json(); } catch(_){ /* ignore */ }
      if(!res.ok || data.ok===false){ throw new Error(data.error||('request_failed_'+res.status)); }
      return data;
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // ============ Users CRUD ============
    const tbody = document.getElementById('usersTbody');
    let currentUsers = [];

    async function loadUsers(){
      try{
        const { users } = await api('adminUsers');
        renderUsers(Array.isArray(users)? users: []);
      }catch(err){ alert('فشل تحميل المستخدمين: '+ err.message); }
    }
    
    // Classes for styled elements
    const rowInputClass = "block w-full text-sm bg-white rounded-md border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500 disabled:bg-slate-50 disabled:text-slate-500";
    const btnClass = "inline-flex items-center justify-center rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all";
    const btnPrimaryClass = "inline-flex items-center justify-center rounded-md border border-transparent bg-red-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all";
    const btnDangerClass = "inline-flex items-center justify-center rounded-md border border-transparent bg-red-800 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all";
    const btnMutedClass = "inline-flex items-center justify-center rounded-md border border-slate-300 bg-slate-100 px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all";


    function rowTemplate(u){
      const tr = document.createElement('tr');
      tr.dataset.email = u.email;
      tr.innerHTML = `
        <td class="px-4 py-3 align-middle"><input class="${rowInputClass}" name="name" value="${escapeHtml(u.name||'')}" /></td>
        <td class="px-4 py-3 align-middle"><input class="${rowInputClass}" name="email" value="${escapeHtml(u.email||'')}" disabled /></td>
        <td class="px-4 py-3 align-middle">
          <select class="${rowInputClass}" name="status">
            <option value="active" ${u.status==='active'? 'selected':''}>فعّال</option>
            <option value="suspended" ${u.status==='suspended'? 'selected':''}>معلّق</option>
          </select>
        </td>
        <td class="px-4 py-3 align-middle"><input class="${rowInputClass}" name="start_date" type="date" value="${u.start_date||''}" /></td>
        <td class="px-4 py-3 align-middle"><input class="${rowInputClass}" name="end_date" type="date" value="${u.end_date||''}" /></td>
        <td class="px-4 py-3 align-middle">
            <div class="flex items-center flex-wrap gap-2">
                <button class="${btnClass} js-edit">تعديل</button>
                <button class="${btnPrimaryClass} js-save hidden">حفظ</button>
                <button class="${btnMutedClass} js-cancel hidden">إلغاء</button>
                <button class="${btnClass} js-reset">إعادة ربط</button>
                <button class="${btnDangerClass} js-delete">حذف</button>
            </div>
        </td>`;
      toggleRowEdit(tr, false);
      attachRowHandlers(tr);
      return tr;
    }

    function toggleRowEdit(tr, editing){
      tr.querySelectorAll('input[name="name"], select[name="status"], input[name="start_date"], input[name="end_date"]').forEach(el=>{
        el.disabled = !editing;
      });
      tr.querySelector('.js-edit').classList.toggle('hidden', editing);
      tr.querySelector('.js-save').classList.toggle('hidden', !editing);
      tr.querySelector('.js-cancel').classList.toggle('hidden', !editing);
    }

    function collectRow(tr){
      const get = (n)=> tr.querySelector(`[name="${n}"]`)?.value ?? null;
      return {
        email: get('email'), name: get('name'), status: tr.querySelector('[name="status"]').value,
        start_date: get('start_date') || null, end_date: get('end_date') || null
      };
    }

    function attachRowHandlers(tr){
      tr.querySelector('.js-edit').addEventListener('click', ()=> toggleRowEdit(tr, true));
      tr.querySelector('.js-cancel').addEventListener('click', ()=> { toggleRowEdit(tr, false); loadUsers(); });
      tr.querySelector('.js-save').addEventListener('click', async ()=>{
        try{
          const payload = collectRow(tr);
          await api('adminUsers','PUT', payload);
          toggleRowEdit(tr, false);
          await loadUsers();
          alert('تم الحفظ');
        }catch(err){ alert('فشل الحفظ: '+ err.message); }
      });
      tr.querySelector('.js-delete').addEventListener('click', async ()=>{
        if(!confirm('حذف المستخدم؟')) return;
        try{ await api('adminUsers','DELETE', { email: tr.dataset.email }); tr.remove(); }
        catch(err){ alert('فشل الحذف: '+ err.message); }
      });
      tr.querySelector('.js-reset').addEventListener('click', async ()=>{
        try{ await api('adminUsers?action=resetDevice','POST', { email: tr.dataset.email }); alert('تمت إعادة ربط الجهاز.'); }
        catch(err){ alert('فشل العملية: '+ err.message); }
      });
    }

    function renderUsers(list){
      currentUsers = Array.isArray(list)? list: [];
      tbody.innerHTML = '';
      currentUsers.forEach(u => tbody.appendChild(rowTemplate(u)));
    }

    document.getElementById('createUserForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const form = e.currentTarget;
      const fd = new FormData(form);
      const email = (fd.get('email')||'').toString().trim().toLowerCase();
      const body = {
        name: (fd.get('name')||'').toString().trim(), email,
        password: (fd.get('password')||'').toString(), status: (fd.get('status')||'active').toString(),
        start_date: fd.get('start_date')||null, end_date: fd.get('end_date')||null,
        device_fingerprint: null, session_nonce: null, lock_reason: null
      };
      const upsert = fd.get('upsert') === 'on';
      const exists = currentUsers.some(u => (u.email||'').toLowerCase() === email);
      try{
        if(exists && !upsert){
          alert('هذا البريد موجود مسبقًا. ضع علامة "حدّث المستخدم بدلًا من الإنشاء" أو غيّر البريد.'); return;
        }
        if(exists && upsert){ await api('adminUsers','PUT', body); } else { await api('adminUsers','POST', body); }
        form.reset();
        await loadUsers();
        alert('تم الحفظ');
      }catch(err){ alert('فشل حفظ المستخدم: '+ err.message); }
    });

    let currentSettings = null;
    async function loadSettings(){
      try{
        const { settings } = await api('adminSettings');
        currentSettings = settings || {};
        renderBranding(); renderContact(); renderDiets(); renderImages(); renderImagesMeta();
      }catch(err){ alert('فشل تحميل الإعدادات: '+err.message); }
    }

    function renderBranding(){
      const f = document.getElementById('brandingForm'); const b = currentSettings.branding || {};
      f.site_name_ar.value = b.site_name_ar || ''; f.site_name_en.value = b.site_name_en || ''; f.logo_url.value = b.logo_url || '';
    }
    function renderContact(){
      const f = document.getElementById('contactForm'); const c = currentSettings.contact || {};
      f.phone_display.value = c.phone_display || ''; f.whatsapp_link.value = c.whatsapp_link || ''; f.email.value = c.email || '';
      const s = (c.social || {}); f.instagram.value = s.instagram || ''; f.tiktok.value = s.tiktok || ''; f.youtube.value = s.youtube || '';
    }
    
    // Re-styled template functions for settings
    const inputClass = "block w-full rounded-md border-slate-300 text-sm";
    const labelClass = "block text-xs font-medium text-slate-500 mb-1";
    const textareaClass = inputClass + " min-h-[80px]";

    function dietItemRow(d){
      const wrap = el('div', { class:'bg-slate-50 border border-slate-200 rounded-lg p-4' });
      wrap.appendChild(el('div', { class:'grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4' }, [
        el('div',{},[el('label',{class:labelClass,text:'ID'}), el('input',{class:inputClass,'data-k':'id', value: d.id||''})]),
        el('div',{},[el('label',{class:labelClass,text:'الاسم (AR)'}), el('input',{class:inputClass,'data-k':'name_ar', value: d.name_ar||''})]),
        el('div',{},[el('label',{class:labelClass,text:'Name (EN)'}), el('input',{class:inputClass,'data-k':'name_en', value: d.name_en||''})]),
      ]));
      wrap.appendChild(el('div', { class:'grid grid-cols-1 sm:grid-cols-2 gap-4' }, [
        el('div',{},[el('label',{class:labelClass,text:'الوصف (AR)'}), el('textarea',{class:textareaClass,'data-k':'description_ar'},[])]),
        el('div',{},[el('label',{class:labelClass,text:'Description (EN)'}), el('textarea',{class:textareaClass,'data-k':'description_en'},[])]),
      ]));
      wrap.querySelector('[data-k="description_ar"]').value = d.description_ar||'';
      wrap.querySelector('[data-k="description_en"]').value = d.description_en||'';
      const tools = el('div', { class:'mt-4' }, [ el('button',{class:btnDangerClass,text:'حذف'}) ]);
      tools.querySelector('button').addEventListener('click',()=>{ wrap.remove(); });
      wrap.appendChild(tools);
      return wrap;
    }

    function renderDiets(){
      const host = document.getElementById('dietsList'); host.innerHTML='';
      (currentSettings.diet_systems||[]).forEach(d=> host.appendChild(dietItemRow(d)));
      document.getElementById('addDietBtn').onclick = ()=>{ host.appendChild(dietItemRow({ id:'', name_ar:'', name_en:'', description_ar:'', description_en:'' })); };
    }

    function imagesRow(k,v){
      const row = el('div', { class:'grid grid-cols-1 sm:grid-cols-[1fr,2fr,auto] gap-2 items-center' }, [
        el('input',{class:inputClass,'data-k':'key', value:k, placeholder: 'key (e.g., hero_bg)'}),
        el('input',{class:inputClass,'data-k':'val', value:v, placeholder: 'https://example.com/image.jpg'}),
        el('button',{class:btnDangerClass,text:'حذف'})
      ]);
      row.querySelector('button').addEventListener('click',()=> row.remove());
      return row;
    }
    function renderImages(){
      const host = document.getElementById('imagesList'); host.innerHTML='';
      const imgs = currentSettings.images || {};
      Object.keys(imgs).forEach(k=> host.appendChild(imagesRow(k, imgs[k])));
      const add = el('button',{class:btnClass + ' mt-2',text:'+ إضافة صورة'});
      add.addEventListener('click',()=> host.insertBefore(imagesRow('', ''), add));
      host.appendChild(add);
    }

    function metaRow(k, ar, en){
      return el('div', { class:'grid grid-cols-1 sm:grid-cols-3 gap-2 items-center' }, [
        el('input',{class:inputClass,'data-k':'key', value:k, placeholder: 'Image key (from above)'}),
        el('input',{class:inputClass,'data-k':'ar', value:ar||'', placeholder:'النص البديل بالعربية'}),
        el('input',{class:inputClass,'data-k':'en', value:en||'', placeholder:'Alt text in English'})
      ]);
    }
    function renderImagesMeta(){
      const host = document.getElementById('imagesMetaList'); host.innerHTML='';
      const meta = currentSettings.images_meta || {};
      Object.keys(meta).forEach(k=> host.appendChild(metaRow(k, meta[k]?.alt_ar, meta[k]?.alt_en)));
      const add = el('button',{class:btnClass + ' mt-2',text:'+ إضافة نص بديل'});
      add.addEventListener('click',()=> host.insertBefore(metaRow('', '', ''), add));
      host.appendChild(add);
    }

    function collectSettings(){
      const b = document.getElementById('brandingForm');
      const branding = { site_name_ar: b.site_name_ar.value.trim(), site_name_en: b.site_name_en.value.trim(), logo_url: b.logo_url.value.trim() };
      const cf = document.getElementById('contactForm');
      const contact = { phone_display: cf.phone_display.value.trim(), whatsapp_link: cf.whatsapp_link.value.trim(), email: cf.email.value.trim(),
        social: { instagram: cf.instagram.value.trim(), tiktok: cf.tiktok.value.trim(), youtube: cf.youtube.value.trim() } };
      const dietsHost = document.getElementById('dietsList');
      const diet_systems = Array.from(dietsHost.querySelectorAll('.bg-slate-50')).map(card=>{
        const get = (sel)=> card.querySelector(`[data-k="${sel}"]`).value.trim();
        return { id:get('id'), name_ar:get('name_ar'), name_en:get('name_en'), description_ar:get('description_ar'), description_en:get('description_en') };
      }).filter(d=> d.id);
      const images = {};
      document.querySelectorAll('#imagesList .grid').forEach(row => {
        const k = row.querySelector('[data-k="key"]')?.value.trim();
        const v = row.querySelector('[data-k="val"]')?.value.trim();
        if(k && v) images[k] = v;
      });
      const images_meta = {};
      document.querySelectorAll('#imagesMetaList .grid').forEach(row => {
        const k = row.querySelector('[data-k="key"]')?.value.trim();
        const ar = row.querySelector('[data-k="ar"]')?.value.trim();
        const en = row.querySelector('[data-k="en"]')?.value.trim();
        if(k) images_meta[k] = { alt_ar: ar, alt_en: en };
      });
      return { branding, contact, diet_systems, images, images_meta };
    }

    document.getElementById('saveSettingsBtn').addEventListener('click', async ()=>{
      try{
        const payload = collectSettings();
        await api('adminSettings','PUT', payload);
        await loadSettings();
        alert('تم حفظ الإعدادات');
      }catch(err){ alert('فشل حفظ الإعدادات: '+ err.message); }
    });

    document.addEventListener('DOMContentLoaded', ()=>{ loadUsers(); loadSettings(); });
  })();
  </script>
</body>
</html>
