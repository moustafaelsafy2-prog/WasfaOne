<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>لوحة التحكم - WasfaOne</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap');
    :root{
      --ink:#0f172a; --muted:#475569; --brand:#ef4444; --line:#e5e7eb; --soft:#f7f7f9;
      --ok:#065f46; --bad:#991b1b; --info:#1f2937;
    }
    *{box-sizing:border-box}
    body{font-family:'Cairo',system-ui,Arial,sans-serif;background:var(--soft);color:var(--ink);min-height:100vh}
    .wrap{max-width:1100px;margin-inline:auto}
    .card{background:#fff;border:1px solid var(--line);border-radius:22px;padding:20px;box-shadow:0 16px 40px rgba(0,0,0,.06)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:14px;font-weight:800}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-soft{background:#fff;border:1px solid var(--line)}
    .btn[disabled]{opacity:.5;pointer-events:none}
    .section-title{font-weight:900;font-size:20px;margin:14px 0}
    .fieldset{border:1px solid var(--line);border-radius:16px;padding:14px;background:#fff}
    .hint{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:18px 0}
    .tag{display:inline-flex;align-items:center;gap:8px;background:#111827;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
    .toast{position:fixed;inset-inline-start:16px;inset-block-start:16px;z-index:60;display:flex;flex-direction:column;gap:8px}
    .toast-item{background:var(--info);color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    .toast-item.success{background:var(--ok)} .toast-item.error{background:var(--bad)}
    .banner{border:1px dashed #b45309;background:#fff7e6;color:#92400e;border-radius:16px;padding:12px}
    .kbd{font-family:ui-monospace, Menlo, monospace; padding:0 6px;border:1px solid var(--line);border-bottom-width:2px;border-radius:6px;background:#f8fafc}
    input[type="text"], input[type="url"], input[type="number"], textarea, select{
      width:100%;min-height:48px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff
    }
    textarea{min-height:96px}
    .diet-row{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fafafa}
    .row-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .muted{color:var(--muted)}
  </style>
</head>
<body class="p-4 md:p-8">
  <div id="toast" class="toast"></div>

  <div class="wrap">
    <!-- شريط التأثير الفوري -->
    <div class="banner card mb-4">
      <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
        <div class="text-sm">
          <strong>تنبيه مهم:</strong>
          أي تعديل تحفظه هنا يتم
          <span class="font-extrabold">تطبيقه فورًا على واجهة المستخدم app.html</span>
          عبر تحديث <span class="kbd">public/data/settings.json</span>.
        </div>
        <div class="flex gap-2">
          <a class="btn btn-soft" href="public/data/settings.json" target="_blank" rel="noopener">استعراض النسخة العامة</a>
          <a class="btn btn-soft" href="app.html" target="_blank" rel="noopener">تحقق من التحديث في app.html</a>
        </div>
      </div>
    </div>

    <!-- رأس الصفحة -->
    <div class="card mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h1 class="text-3xl md:text-4xl font-black">لوحة التحكم (Admin)</h1>
        <div class="flex items-center gap-2">
          <span class="tag" id="envTag">وضع الاتصال: —</span>
          <button id="saveBtn" class="btn btn-primary">حفظ الإعدادات الآن</button>
        </div>
      </div>
      <p class="mt-2 text-sm muted">تأكّد من إدخال مفتاح الأدمن الصحيح. يتم تخزينه محليًا على جهازك فقط.</p>
      <div class="grid-auto mt-3">
        <div>
          <label class="block text-sm muted mb-1">مفتاح الأدمن (x-admin-key)</label>
          <input id="adminKey" type="text" placeholder="••••••••" autocomplete="off">
          <p class="hint mt-1">لن يُرسل المفتاح إلا مع الطلبات إلى <span class="kbd">/.netlify/functions/adminSettings</span>.</p>
        </div>
        <div>
          <label class="block text-sm muted mb-1">فرع المستودع (اختياري)</label>
          <input id="branch" type="text" placeholder="main">
          <p class="hint mt-1">يُستخدم لعرضه فقط كمرجع. التحكم الفعلي من خلال إعدادات الوظيفة.</p>
        </div>
      </div>
    </div>

    <!-- تبويبات مبسطة -->
    <div class="card">
      <div class="flex flex-wrap gap-2 mb-4">
        <button data-tab="branding" class="btn btn-soft" id="tab-branding">الهوية</button>
        <button data-tab="contact" class="btn btn-soft" id="tab-contact">وسائل التواصل</button>
        <button data-tab="diets" class="btn btn-soft" id="tab-diets">الأنظمة الغذائية</button>
        <button data-tab="images" class="btn btn-soft" id="tab-images">الصور والنصوص البديلة</button>
      </div>

      <!-- الهوية -->
      <section id="panel-branding" class="fieldset">
        <h2 class="section-title">الهوية (Branding)</h2>
        <div class="grid-auto">
          <div>
            <label class="block text-sm muted mb-1">اسم الموقع (عربي)</label>
            <input id="site_name_ar" type="text" placeholder="WasfaOne">
          </div>
          <div>
            <label class="block text-sm muted mb-1">اسم الموقع (إنجليزي)</label>
            <input id="site_name_en" type="text" placeholder="WasfaOne">
          </div>
          <div class="col">
            <label class="block text-sm muted mb-1">رابط الشعار (Logo URL)</label>
            <input id="logo_url" type="url" placeholder="https://…/logo.png">
          </div>
        </div>
      </section>

      <div class="divider"></div>

      <!-- التواصل -->
      <section id="panel-contact" class="fieldset">
        <h2 class="section-title">وسائل التواصل</h2>
        <div class="grid-auto">
          <div>
            <label class="block text-sm muted mb-1">رقم/نص العرض</label>
            <input id="phone_display" type="text" placeholder="+971… أو نص">
          </div>
          <div>
            <label class="block text-sm muted mb-1">رابط واتساب</label>
            <input id="whatsapp_link" type="url" placeholder="https://wa.me/…">
          </div>
          <div>
            <label class="block text-sm muted mb-1">البريد</label>
            <input id="email" type="text" placeholder="support@example.com">
          </div>
        </div>
        <div class="mt-3">
          <label class="block text-sm muted mb-1">روابط شبكات التواصل (JSON)</label>
          <textarea id="social_json" placeholder='{"twitter":"…","instagram":"…"}'></textarea>
          <p class="hint mt-1">أدخل كائن JSON بسيط بالمفاتيح التي تريدها.</p>
        </div>
      </section>

      <div class="divider"></div>

      <!-- الأنظمة الغذائية -->
      <section id="panel-diets" class="fieldset">
        <div class="flex items-center justify-between">
          <h2 class="section-title">الأنظمة الغذائية</h2>
          <button id="addDiet" class="btn btn-soft">+ إضافة نظام</button>
        </div>
        <div id="dietsBox" class="flex flex-col gap-3"></div>
        <p class="hint mt-2">سيتم تصدير هذه القائمة أيضًا إلى <span class="kbd">public/data/settings.json</span> تحت الحقل <span class="kbd">diets</span> لتقرأها <span class="kbd">app.html</span> مباشرة.</p>
      </section>

      <div class="divider"></div>

      <!-- الصور والنصوص البديلة -->
      <section id="panel-images" class="fieldset">
        <h2 class="section-title">الصور والنصوص البديلة</h2>
        <div class="grid-auto">
          <div>
            <label class="block text-sm muted mb-1">صور (JSON)</label>
            <textarea id="images_json" placeholder='{"hero":"https://…/hero.jpg"}'></textarea>
            <p class="hint mt-1">مفاتيح حرة حسب احتياجك (hero, about, …).</p>
          </div>
          <div>
            <label class="block text-sm muted mb-1">بيانات بديلة/وصفية (JSON)</label>
            <textarea id="images_meta_json" placeholder='{"hero":{"alt_ar":"…","alt_en":"…"}}'></textarea>
            <p class="hint mt-1">إن وُجدت <span class="kbd">alt_ar</span> و <span class="kbd">alt_en</span> سيتم تبسيطها إلى <span class="kbd">alts</span> في النسخة العامة.</p>
          </div>
        </div>
      </section>
    </div>

    <div class="mt-6 flex gap-2">
      <button id="saveBtnBottom" class="btn btn-primary">حفظ الإعدادات الآن</button>
      <a class="btn btn-soft" href="public/data/settings.json" target="_blank" rel="noopener">فتح النسخة العامة</a>
      <a class="btn btn-soft" href="app.html" target="_blank" rel="noopener">فتح app.html</a>
    </div>

    <p class="mt-3 text-xs muted">© WasfaOne — سيتم حفظ نسخة رسمية في <span class="kbd">data/settings.json</span> ونسخة عامة للواجهات في <span class="kbd">public/data/settings.json</span>.</p>
  </div>

  <script>
    // ====== إعدادات عامة ======
    const API = "/.netlify/functions/adminSettings";
    const $ = (id) => document.getElementById(id);
    const toast = $("toast");

    // عناصر الإدخال
    const adminKey = $("adminKey");
    const branch = $("branch");
    const saveBtn = $("saveBtn");
    const saveBtnBottom = $("saveBtnBottom");
    const envTag = $("envTag");

    // Panels inputs
    const site_name_ar = $("site_name_ar");
    const site_name_en = $("site_name_en");
    const logo_url = $("logo_url");

    const phone_display = $("phone_display");
    const whatsapp_link = $("whatsapp_link");
    const email = $("email");
    const social_json = $("social_json");

    const dietsBox = $("dietsBox");
    const addDiet = $("addDiet");

    const images_json = $("images_json");
    const images_meta_json = $("images_meta_json");

    // ====== Utilities ======
    function pushToast(text, type="info", ms=3500){
      const d=document.createElement('div');
      d.className=`toast-item ${type}`; d.textContent=text; toast.appendChild(d);
      setTimeout(()=>{ d.style.opacity='0'; d.style.transform='translateY(-4px)'; }, ms-400);
      setTimeout(()=>d.remove(), ms);
    }
    function safeParse(json, fallback){
      try{ return JSON.parse(json||""); }catch(_){ return fallback }
    }
    function toJson(obj){ return JSON.stringify(obj||{}, null, 2) }

    function saveLocal(){
      const key = (adminKey.value||"").trim();
      if(key){ localStorage.setItem("wasfa_admin_key", key) }
      const br = (branch.value||"").trim();
      localStorage.setItem("wasfa_branch_hint", br)
    }
    function loadLocal(){
      const key = localStorage.getItem("wasfa_admin_key") || "";
      const br = localStorage.getItem("wasfa_branch_hint") || "main";
      adminKey.value = key;
      branch.value = br;
      envTag.textContent = `وضع الاتصال: ${br}`;
    }

    // ====== Diet rows ======
    function dietRowTemplate(d = {}){
      const id = crypto.randomUUID();
      return `
        <div class="diet-row" data-id="${id}">
          <div class="row-head">
            <strong>${d.name_ar || d.name_en || d.id || "نظام جديد"}</strong>
            <div class="flex gap-2">
              <button class="btn btn-soft" data-act="dup">نسخ</button>
              <button class="btn btn-soft" data-act="del">حذف</button>
            </div>
          </div>
          <div class="grid-auto mt-3">
            <div><label class="block text-sm muted mb-1">المعرّف</label><input data-k="id" type="text" value="${d.id||""}" placeholder="unique-id"></div>
            <div><label class="block text-sm muted mb-1">الاسم (عربي)</label><input data-k="name_ar" type="text" value="${d.name_ar||""}"></div>
            <div><label class="block text-sm muted mb-1">الاسم (إنجليزي)</label><input data-k="name_en" type="text" value="${d.name_en||""}"></div>
          </div>
          <div class="grid-auto mt-3">
            <div><label class="block text-sm muted mb-1">وصف (عربي)</label><textarea data-k="description_ar">${d.description_ar||""}</textarea></div>
            <div><label class="block text-sm muted mb-1">وصف (إنجليزي)</label><textarea data-k="description_en">${d.description_en||""}</textarea></div>
          </div>
        </div>
      `;
    }
    function mountDietRowEvents(row){
      row.querySelector('[data-act="del"]').addEventListener('click', ()=>{ row.remove(); pushToast("تم حذف النظام","info") });
      row.querySelector('[data-act="dup"]').addEventListener('click', ()=>{
        const d = collectDietFromRow(row);
        addDietRow(d);
        pushToast("تم نسخ النظام","info");
      });
    }
    function addDietRow(d){ const wrapper=document.createElement('div'); wrapper.innerHTML=dietRowTemplate(d); const row=wrapper.firstElementChild; dietsBox.appendChild(row); mountDietRowEvents(row) }
    function collectDietFromRow(row){
      const o={};
      row.querySelectorAll('[data-k]').forEach(inp=>{ o[inp.dataset.k]=inp.value.trim() });
      return o;
    }
    function collectAllDiets(){
      const arr=[];
      dietsBox.querySelectorAll('.diet-row').forEach(r=>arr.push(collectDietFromRow(r)));
      return arr;
    }

    // ====== API ======
    async function apiGet(){
      const key=(adminKey.value||"").trim();
      if(!key){ pushToast("أدخل مفتاح الأدمن أولًا","error"); throw new Error("no_key") }
      const r = await fetch(API, { headers:{ "x-admin-key": key } });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok){ throw new Error(j?.error || `GET_FAILED_${r.status}`) }
      return j.settings || {};
    }
    async function apiPut(next){
      const key=(adminKey.value||"").trim();
      if(!key){ pushToast("أدخل مفتاح الأدمن أولًا","error"); throw new Error("no_key") }
      const r = await fetch(API, {
        method:"PUT",
        headers:{ "content-type":"application/json", "x-admin-key": key },
        body: JSON.stringify(next)
      });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok){ throw new Error(j?.error || `PUT_FAILED_${r.status}`) }
      return j.settings || {};
    }

    // ====== Hydration ======
    function hydrateUI(s){
      // Branding
      site_name_ar.value = s?.branding?.site_name_ar || "WasfaOne";
      site_name_en.value = s?.branding?.site_name_en || "WasfaOne";
      logo_url.value     = s?.branding?.logo_url     || "";

      // Contact
      phone_display.value = s?.contact?.phone_display || "";
      whatsapp_link.value = s?.contact?.whatsapp_link || "";
      email.value         = s?.contact?.email || "";
      social_json.value   = toJson(s?.contact?.social || {});

      // Diets
      dietsBox.innerHTML = "";
      (Array.isArray(s?.diet_systems) ? s.diet_systems : []).forEach(d => addDietRow(d));
      if(!dietsBox.children.length) addDietRow({ id:"default", name_ar:"عادي/متوازن", name_en:"Balanced" });

      // Images/meta
      images_json.value      = toJson(s?.images || {});
      images_meta_json.value = toJson(s?.images_meta || {});
    }

    function gatherPayload(){
      const social = safeParse(social_json.value, {});
      const images = safeParse(images_json.value, {});
      const images_meta = safeParse(images_meta_json.value, {});
      return {
        branding:{
          site_name_ar: site_name_ar.value.trim(),
          site_name_en: site_name_en.value.trim(),
          logo_url: logo_url.value.trim()
        },
        contact:{
          phone_display: phone_display.value.trim(),
          whatsapp_link: whatsapp_link.value.trim(),
          email: email.value.trim(),
          social
        },
        diet_systems: collectAllDiets(),
        images, images_meta
      };
    }

    // ====== Tabs (بساطة) ======
    const tabs = {
      branding: { btn: $("tab-branding"), panel: $("panel-branding") },
      contact:  { btn: $("tab-contact"),  panel: $("panel-contact") },
      diets:    { btn: $("tab-diets"),    panel: $("panel-diets") },
      images:   { btn: $("tab-images"),   panel: $("panel-images") },
    };
    function showTab(name){
      Object.entries(tabs).forEach(([k,v])=>{
        v.btn.classList.toggle("btn-primary", k===name);
        v.btn.classList.toggle("btn-soft", k!==name);
        v.panel.style.display = k===name? "block":"none";
      });
      localStorage.setItem("wasfa_admin_tab", name);
    }

    // ====== Init ======
    async function init(){
      loadLocal();
      Object.values(tabs).forEach(t => t.btn.addEventListener('click', ()=>showTab(t.btn.dataset.tab)));
      showTab(localStorage.getItem("wasfa_admin_tab") || "branding");

      addDiet.addEventListener('click', ()=> addDietRow({}));

      saveBtn.addEventListener('click', onSave);
      saveBtnBottom.addEventListener('click', onSave);

      // جلب الإعدادات الحالية
      try{
        const s = await apiGet();
        hydrateUI(s);
        pushToast("تم تحميل الإعدادات","success");
      }catch(e){
        console.error(e);
        pushToast("تعذر تحميل الإعدادات — أدخل مفتاح الأدمن ثم أعد المحاولة","error",5000);
      }

      // حفظ المفتاح تلقائيًا عند تغييره
      adminKey.addEventListener('change', saveLocal);
      branch.addEventListener('change', saveLocal);
    }

    async function onSave(){
      try{
        saveBtn.disabled = saveBtnBottom.disabled = true;
        pushToast("جارٍ الحفظ…","info");
        const payload = gatherPayload();
        await apiPut(payload);
        pushToast("تم الحفظ وتحديث النسخة العامة — سيظهر فورًا في app.html","success");
        // فتح النسخة العامة في نافذة جديدة اختياريًا:
        // window.open("public/data/settings.json", "_blank");
      }catch(e){
        console.error(e);
        pushToast(e?.message || "فشل الحفظ","error",6000);
      }finally{
        saveBtn.disabled = saveBtnBottom.disabled = false;
      }
    }

    // ابدأ
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
