<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wasfa | وصفة</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap');
    /* ============================================
      DESIGN SYSTEM & VARIABLES
      ============================================
    */
    :root{ 
      --ink:#0f172a; 
      --muted:#64748b; 
      --brand:#ef4444; 
      --brand-soft: #fef2f2;
      --soft-bg: #f8fafc; 
      --line:#e2e8f0; 
      --success: #22c55e;
      --error: #ef4444;
      --info: #3b82f6;
    }
    
    *{ box-sizing:border-box }
    
    html { scroll-behavior: smooth; }

    body {
      font-family:'Cairo', sans-serif;
      background: var(--soft-bg);
      color: var(--ink);
      min-height:100vh;
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .wrap{ max-width:1080px; margin-inline:auto }

    /* ============================================
      CORE COMPONENTS & STYLES
      ============================================
    */
    .card {
      background: #ffffff;
      border: 1px solid var(--line);
      border-radius: 28px;
      padding: 28px;
      box-shadow: 0 10px 15px -3px rgba(15, 23, 42, .05), 0 4px 6px -4px rgba(15, 23, 42, .05);
    }
    
    .divider{ height:1px; background: linear-gradient(to left, transparent, var(--line), transparent); margin: 24px 0 }
    
    .area{ display:grid; grid-template-columns: .8fr 1.2fr; gap:28px; align-items:start }
    @media (max-width:1024px){ .area{grid-template-columns:1fr} }
    
    /* Header */
    .brand-title {
        font-weight: 900;
        color: transparent;
        background-clip: text;
        -webkit-background-clip: text;
        background-image: linear-gradient(to right, #b91c1c, var(--brand));
    }
    
    /* Forms */
    .form-group { position: relative; }
    .form-label { display: block; font-weight: 600; color: var(--muted); margin-bottom: 8px; font-size: 0.9rem; }
    .form-field {
        width: 100%;
        min-height: 52px;
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 0 16px;
        background-color: #fcfdff;
        transition: all .2s ease-in-out;
        box-shadow: 0 1px 2px 0 rgba(0,0,0,.03);
    }
    .form-field:focus {
        outline: none;
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, .1);
        background-color: #fff;
    }
    textarea.form-field { padding: 12px 16px; }

    /* Main Button */
    #generateBtn {
        border-radius: 16px;
        padding: 14px 28px;
        font-weight: 800;
        color: white;
        background-image: linear-gradient(to top right, var(--brand), #fb7185);
        box-shadow: 0 4px 12px rgba(239, 68, 68, .2), 0 2px 4px rgba(239, 68, 68, .2);
        transition: all .2s ease-out;
    }
    #generateBtn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(239, 68, 68, .3), 0 4px 8px rgba(239, 68, 68, .25);
        filter: brightness(1.05);
    }
    #generateBtn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* ============================================
      RESULTS AREA STYLES
      ============================================
    */
    .section-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.75rem;
        font-weight: 900;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--line);
        margin-bottom: 1.25rem;
    }
    .section-title svg { width: 24px; height: 24px; color: var(--brand); }

    .meta{ display:flex; gap:14px; flex-wrap:wrap }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 14px; border:1px solid var(--line); border-radius:999px; background:#fff; font-weight:700; font-size: 0.9rem; }
    .chip svg{ width:18px; height:18px; color:var(--brand) }
    
    /* Nutrition Pills */
    .tl-wrap{ display:flex; gap:12px; flex-wrap:wrap }
    .tl-pill { flex:1 1 120px; border-radius:18px; padding:12px; border:1px solid; text-align:center; transition: all .2s ease-out; }
    .tl-pill:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,.06); }
    .tl-pill .name{ display:block; font-weight:800; font-size:14px; }
    .tl-pill .grams{ display:block; font-weight:900; font-size:18px; margin-top:4px }
    .tl-pill .flag{ display:inline-block; margin-top:6px; padding:2px 8px; border-radius:999px; font-weight:800; font-size:12px; }
    .tl-low { background: #f0fdf4; border-color: #4ade80; color: #15803d; }
    .tl-med { background: #fffbeb; border-color: #facc15; color: #a16207; }
    .tl-high { background: #fef2f2; border-color: #f87171; color: #b91c1c; }
    .tl-low .flag { background-color: #dcfce7; color: #166534; }
    .tl-med .flag { background-color: #fef3c7; color: #854d0e; }
    .tl-high .flag { background-color: #fee2e2; color: #991b1b; }
    
    /* Ingredients & Steps */
    .panel{ position:sticky; top:24px; background:#fff; border:1px solid var(--line); border-radius:22px; padding:22px; box-shadow:0 12px 30px rgba(0,0,0,.04) }
    .ingredient-list li{ position:relative; padding-right:1.5rem; line-height:1.9; margin-bottom:.5rem; color: var(--muted); }
    .ingredient-list li::before{ content:''; position:absolute; right:0; top: 10px; width: 8px; height: 8px; border-radius: 50%; background:var(--brand); box-shadow: 0 0 8px rgba(239, 68, 68, .5); }
    
    .steps-list { counter-reset:step; position:relative; padding-right:25px; margin-right:15px; }
    .steps-list::before { content:''; position:absolute; right:0; top:16px; bottom:16px; width:2px; background: repeating-linear-gradient(to bottom, var(--line), var(--line) 4px, transparent 4px, transparent 8px); z-index:0; }
    .step { position:relative; background:#fff; border:1px solid var(--line); border-radius:18px; padding:20px 24px; box-shadow:0 4px 10px rgba(0,0,0,.03); margin-bottom:20px; transition: all .2s ease-out; }
    .step:hover { transform: translateX(-5px); border-color: #d1d5db; box-shadow: 0 8px 15px rgba(0,0,0,.05); }
    .step::before {
      counter-increment:step; content:counter(step);
      position:absolute; right:-41px; top:50%; transform:translateY(-50%);
      width:32px; height:32px; border-radius:999px;
      display:grid; place-items:center;
      color:#fff; background:var(--brand); font-weight:700; border:3px solid #fff;
      box-shadow:0 0 0 2px var(--brand); z-index:1;
    }
    .step p{ margin:0; color:var(--muted); line-height:1.95 }

    /* ============================================
      UTILITIES & HELPERS
      ============================================
    */
    /* Banners & Toasts */
    .banner{ border:1px dashed; padding: 12px 16px; border-radius: 16px; }
    .banner.amber{ border-color:#f59e0b; background:#fffbeb; color:#92400e }
    .banner.red{ border-color:#f43f5e; background:#fff1f2; color:#be123c }
    
    .toast{ position:fixed; inset-inline-start:16px; inset-block-start:16px; z-index:50; display: flex; flex-direction: column; gap: 8px; }
    .toast-item{ background:#111827; color:#fff; padding:12px 18px; border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.25); font-weight: 600; transition: all 0.4s ease-out; }
    .toast-item.success{ background:#16a34a }
    .toast-item.error{ background:#dc2626 }
    .toast-item.info{ background:#2563eb }
    
    /* Loader */
    .loader{ border-top-color:var(--brand); animation:spin 1.2s linear infinite; border:3px solid rgba(239, 68, 68, .2); width:24px; height:24px; border-radius:999px }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    
    /* Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
  </style>
</head>
<body class="p-4 md:p-8">
  <div id="toast" class="toast"></div>

  <div class="wrap">
    <div class="card mb-8">
      <div class="flex justify-end">
        <button id="logoutBtn" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-[var(--line)] bg-white hover:bg-gray-50 text-[var(--ink)] font-bold transition-colors">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h4a2 2 0 012 2v1"/></svg>
          <span>تسجيل الخروج</span>
        </button>
      </div>

      <h1 class="brand-title text-4xl md:text-5xl font-black text-center">Wasfa | وصفة</h1>
      <p class="text-center text-lg text-[var(--muted)] mt-2 mb-4">التغذية الذكية .. لصحة مثالية</p>

      <div class="divider"></div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-4 gap-y-6">
        <div class="form-group">
          <label for="mealType" class="form-label">نوع الوجبة</label>
          <select id="mealType" class="form-field">
            <option>غداء</option><option>فطور</option><option selected>عشاء</option><option>وجبة خفيفة</option><option>شوربة</option> <option>سلطة</option><option>حلويات</option>
          </select>
        </div>
        <div class="form-group">
          <label for="cuisine" class="form-label">المطبخ</label>
          <select id="cuisine" class="form-field">
            <option selected>شرق أوسطي</option><option>مطبخ مصري</option><option>مطبخ شامي</option><option>مطبخ خليجي</option><option>مغربي/تونسي/جزائري</option><option>يمني</option><option>تركي</option><option>يوناني</option><option>إيطالي</option><option>إسباني</option><option>فرنسي</option><option>ألماني/نمساوي</option><option>متوسطي (Mediterranean)</option><option>فارسي/إيراني</option><option>هندي</option><option>باكستاني</option><option>أفغاني</option><option>صيني</option><option>ياباني</option><option>كوري</option><option>تايلندي</option><option>فيتنامي</option><option>فلبيني</option><option>مكسيكي</option><option>بيروفي/لاتيني</option><option>أمريكي</option><option>بحري/مأكولات بحرية</option><option>أفريقي/إثيوبي</option><option>عالمي/مبتكر</option>
          </select>
        </div>
        <div class="form-group">
          <label for="dietType" class="form-label">النظام الغذائي</label>
          <select id="dietType" class="form-field"></select>
          <p class="text-xs text-slate-500 mt-1" id="dietHelp"></p>
        </div>
        <div class="form-group">
          <label for="calorieTarget" class="form-label">سعرات الحصة</label>
          <input id="calorieTarget" type="number" min="100" max="2000" step="50" value="550" class="form-field" placeholder="مثال: 500">
        </div>
      </div>

      <div id="customMacrosBox" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4 hidden">
        <div class="form-group">
          <label for="customProtein" class="form-label">بروتين (جم/حصة)</label>
          <input id="customProtein" type="number" min="0" step="1" value="30" class="form-field" placeholder="مثال: 30">
        </div>
        <div class="form-group">
          <label for="customCarbs" class="form-label">كربوهيدرات (جم/حصة)</label>
          <input id="customCarbs" type="number" min="0" step="1" value="35" class="form-field" placeholder="مثال: 35">
        </div>
        <div class="form-group">
          <label for="customFat" class="form-label">دهون (جم/حصة)</label>
          <input id="customFat" type="number" min="0" step="1" value="20" class="form-field" placeholder="مثال: 20">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="form-group">
          <label for="commonAllergy" class="form-label">حساسية شائعة</label>
          <select id="commonAllergy" class="form-field">
            <option value="">لا يوجد</option><option>حساسية القمح/الجلوتين</option><option>حساسية الألبان/اللاكتوز</option><option>حساسية المكسرات</option><option>حساسية البيض</option><option>حساسية المأكولات البحرية</option><option>حساسية فول الصويا</option>
          </select>
        </div>
        <div class="form-group">
          <label for="customAllergy" class="form-label">حساسيات أخرى (اختياري)</label>
          <input id="customAllergy" type="text" class="form-field" placeholder="الثوم، الفول السوداني …">
        </div>
      </div>

      <div class="mt-4 form-group">
        <label for="availableIngredients" class="form-label">المكوّنات المتاحة لديك (اختياري)</label>
        <textarea id="availableIngredients" class="form-field" rows="3" placeholder="اكتب المكونات مفصولة بفواصل أو أسطر: صدر دجاج، كوسا، فلفل ألوان، زيت زيتون"></textarea>
        <p class="text-xs text-slate-500 mt-1">سنحاول بناء الوصفة اعتمادًا على هذه القائمة مع السماح بإضافات بسيطة ضرورية فقط.</p>
      </div>

      <div id="banner" class="hidden mt-4 text-sm banner"></div>

      <div class="text-center my-6">
        <button id="generateBtn" class="inline-flex items-center gap-3">
          <span>توليد الوصفة الآن</span><span id="loadingIndicator" class="hidden loader"></span>
        </button>
        <p id="statusMsg" class="mt-2 text-sm text-blue-600 hidden"></p>
        <p id="errorMsg" class="mt-2 text-sm text-red-600 hidden"></p>
      </div>
      
      <!-- Container for Results -->
      <div id="resultContainer" class="hidden">
        <div class="divider"></div>
        <div class="mb-4">
          <h2 id="recipeTitle" class="text-3xl md:text-4xl font-black leading-snug"></h2>
          <div class="meta mt-4 text-[var(--muted)]">
            <span class="chip">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span id="timeValue">—</span>
            </span>
            <span class="chip">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2A3 3 0 005.356 18.143 3 3 0 005 20h5V20m0 0h10a2 2 0 002-2v-2a3 3 0 00-5.356-1.857M10 20v-2a3 3 0 0110.356 1.857 3 3 0 01-10.356 0zM6 10a3 3 0 11-6 0 3 3 0 016 0zM17 4a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              <span id="servingsValue">—</span>
            </span>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="M12 6v6l4 2"></path></svg>
            <span>المعلومات الغذائية</span>
          </h3>
          <div id="tl-wrap" class="tl-wrap"></div>
        </div>
      </div>
    </div>

    <section id="contentArea" class="area mt-8 hidden">
      <aside class="panel">
        <h3 class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.5 4l-1.5 1.5M19 9l-1.5 1.5M2 12h1.5M6.5 6.5l1 1M18 18l-1-1M12 2v1.5M12 20.5V22M4 15.5l1.5-1.5M9 19l1.5-1.5M12 12a3.5 3.5 0 00-3.5 3.5v0a3.5 3.5 0 006.364 2.136l1.636-1.636a3.5 3.5 0 00-2.136-6.364v0A3.5 3.5 0 0012 12z"></path></svg>
          <span>المكونات</span>
        </h3>
        <ul id="ingredientsList" class="ingredient-list"></ul>
      </aside>

      <main>
        <h3 class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12c0-2.2-1.8-4-4-4H8c-2.2 0-4 1.8-4 4v4c0 2.2 1.8 4 4 4h8c2.2 0 4-1.8 4-4Z"></path><path d="M18 16h-4a2 2 0 110-4h4v4Z"></path><path d="m14 8 1.8-1.8c.6-.6 1.4-.9 2.2-.9H20v2.5c0 .8-.3 1.6-.9 2.2L19.5 8"></path></svg>
          <span>طريقة التحضير</span>
        </h3>
        <div id="preparationSteps" class="steps-list"></div>
      </main>
    </section>
  </div>

<script>
  const API_ENDPOINT="/.netlify/functions/generateRecipe";
  const $=id=>document.getElementById(id);

  // inputs
  const mealType=$('mealType'), cuisine=$('cuisine'), dietType=$('dietType'),
        calorieTarget=$('calorieTarget'), commonAllergy=$('commonAllergy'),
        customAllergy=$('customAllergy'),
        availableIngredients=$('availableIngredients'),
        btn=$('generateBtn'), spin=$('loadingIndicator'),
        statusMsg=$('statusMsg'), errMsg=$('errorMsg'),
        banner=$('banner'), toast=$('toast'), dietHelp=$('dietHelp'),
        customBox=$('customMacrosBox'), customProtein=$('customProtein'),
        customCarbs=$('customCarbs'), customFat=$('customFat');

  // outputs
  const resultContainer = $('resultContainer'), contentArea = $('contentArea'),
        recipeTitle=$('recipeTitle'), timeValue=$('timeValue'),
        servingsValue=$('servingsValue'), ingList=$('ingredientsList'),
        stepsBox=$('preparationSteps'), tlWrap=$('tl-wrap');

  /* ===== Toast ===== */
  function pushToast(text,type="info",ms=3500){
    const d=document.createElement('div');
    d.className=`toast-item ${type}`; d.textContent=text; toast.appendChild(d);
    setTimeout(()=>{ d.style.opacity='0'; d.style.transform='translateY(-4px)'; }, ms-400);
    setTimeout(()=>d.remove(), ms);
  }

  function setStatus(text="", good=true){
    statusMsg.textContent=text;
    statusMsg.classList.toggle('hidden', !text);
    statusMsg.classList.toggle('text-blue-600', good);
    statusMsg.classList.toggle('text-red-600', !good);
  }
  function setError(text=""){ errMsg.textContent=text; errMsg.classList.toggle('hidden', !text) }
  function setBanner(text="", tone="amber"){
    if(!text){ banner.classList.add('hidden'); banner.textContent=""; return; }
    banner.textContent=text;
    banner.classList.remove('hidden','amber', 'red');
    if(tone==="red") banner.classList.add('red');
    if(tone==="amber") banner.classList.add('amber');
  }

  function resetView(){
    setBanner("");
    resultContainer.classList.add('hidden');
    contentArea.classList.add('hidden');
    // Remove animation classes for next run
    resultContainer.classList.remove('fade-in-up');
    contentArea.classList.remove('fade-in-up');
    contentArea.style.animationDelay = '';

    recipeTitle.textContent=""; timeValue.textContent="—"; servingsValue.textContent="—";
    ingList.innerHTML=""; stepsBox.innerHTML=""; tlWrap.innerHTML="";
  }

  function tlClass(v,low,high){ return v<=low?"tl-low":v>=high?"tl-high":"tl-med"; }
  function renderTL(m){
    const fatC=tlClass(m.fats,10,20), carbC=tlClass(m.carbs,30,60), proC=tlClass(m.protein,15,30);
    tlWrap.innerHTML=[
      {n:"الطاقة",g:`${Math.round(m.calories)} kcal`,c:"tl-med",f:"—"},
      {n:"دهون",g:`${Math.round(m.fats)}g`,c:fatC,f:fatC==="tl-high"?"عالي":fatC==="tl-low"?"منخفض":"متوسط"},
      {n:"كربوهيدرات",g:`${Math.round(m.carbs)}g`,c:carbC,f:carbC==="tl-high"?"عالي":carbC==="tl-low"?"منخفض":"متوسط"},
      {n:"بروتين",g:`${Math.round(m.protein)}g`,c:proC,f:proC==="tl-high"?"عالي":proC==="tl-low"?"منخفض":"متوسط"}
    ].map(p=>`<div class="tl-pill ${p.c}"><span class="name">${p.n}</span><span class="grams">${p.g}</span><span class="flag">${p.f}</span></div>`).join("");
  }

  function map(rec){
    return {
      title: rec.title,
      time: `جاهز في ${rec.total_time_min} دقيقة`,
      servingsText: `${rec.servings} حصة`,
      macros: {
        calories:+rec.macros.calories||0,
        protein:+rec.macros.protein_g||0,
        carbs:+rec.macros.carbs_g||0,
        fats:+rec.macros.fat_g||0,
      },
      ingredients: (rec.ingredients||[]).map(x=>({name:x})),
      steps: rec.steps||[]
    };
  }

  async function callAPI(payload){
    const sess = JSON.parse(localStorage.getItem("wasfa_session")||"null");
    if(!sess || !sess.auth_token || !sess.session_nonce){
      window.location.replace("login.html"); return { ok:false };
    }
    const r=await fetch(API_ENDPOINT,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-auth-token": sess.auth_token,
        "x-session-nonce": sess.session_nonce
      },
      body:JSON.stringify(payload)
    });
    const data=await r.json().catch(()=>({}));
    if(!r.ok||!data.ok) throw new Error(data?.error||`تعذر الاتصال (${r.status})`);
    return data;
  }

  function render(view, note, warning){
    resultContainer.classList.remove('hidden');
    resultContainer.classList.add('fade-in-up');
    contentArea.classList.remove('hidden');
    contentArea.style.animationDelay = '0.2s';
    contentArea.classList.add('fade-in-up');

    recipeTitle.textContent=view.title;
    timeValue.textContent=view.time;
    servingsValue.textContent=view.servingsText;
    ingList.innerHTML=view.ingredients.map(i=>`<li>${i.name}</li>`).join("");
    const cleanSteps = (Array.isArray(view.steps) ? view.steps : []).map(s => String(s || "").trim()).filter(Boolean);
    stepsBox.innerHTML = cleanSteps.map(s=>`<div class="step"><p>${s}</p></div>`).join("");
    renderTL(view.macros);

    if (warning) setBanner("تنبيه: تم توليد الوصفة لكن بعض قيود النظام المختار أو المكونات المتاحة قد لا تكون مطبّقة بالكامل.", "amber");
    if (note === "repaired_to_meet_dr_moh_rules") setBanner("تم ضبط الوصفة تلقائيًا لتتوافق مع قواعد نظام د. محمد سعيد.", "amber");
    if (note === "aligned_with_available_ingredients") setBanner("تمت مواءمة الوصفة مع المكونات المتاحة لديك.", "amber");

    // Scroll to results smoothly
    setTimeout(()=> {
        const targetElement = $('resultContainer');
        if (targetElement) {
            const headerOffset = 80;
            const elementPosition = targetElement.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
            window.scrollTo({
                 top: offsetPosition,
                 behavior: "smooth"
            });
        }
    }, 150);
  }

  function parseAvailableList(text){
    if(!text) return [];
    const parts = text
      .split(/[\n,،]+/).map(s=>s.trim()).filter(Boolean)
      .map(s=>s.replace(/\s+/g,' '));
    return Array.from(new Set(parts));
  }

  async function generate(){
    setError(""); setStatus("جارٍ التوليد …", true);
    btn.disabled=true; spin.classList.remove('hidden'); pushToast("جارٍ توليد الوصفة…","info");
    try{
      const allergies=[]; if(commonAllergy.value) allergies.push(commonAllergy.value);
      if(customAllergy.value.trim()) allergies.push(customAllergy.value.trim());
      const isCustom = (dietType.value === 'custom');
      const customMacros = isCustom ? {
        protein_g: Number(customProtein.value)||0,
        carbs_g: Number(customCarbs.value)||0,
        fat_g: Number(customFat.value)||0
      } : null;

      const payload={
        mealType:mealType.value,
        cuisine:cuisine.value,
        dietType:dietType.value,
        caloriesTarget:Number(calorieTarget.value)||500,
        customMacros,
        allergies,
        availableIngredients: parseAvailableList(availableIngredients.value),
        lang:"ar"
      };
      const data=await callAPI(payload);
      const view=map(data.recipe);
      render(view, data.note, data.warning);
      setStatus(`تم التوليد بنجاح`, true);
      pushToast(`تم توليد الوصفة بنجاح`,"success");
    }catch(e){
      setStatus("", true);
      setError(e.message||"فشل التوليد");
      pushToast(e.message||"فشل التوليد","error",5000);
    }finally{
      btn.disabled=false; spin.classList.add('hidden');
    }
  }

  async function loadPublicSettingsAndBind(){
    try{
      const res = await fetch("data/settings.json?ts="+Date.now(), { cache:"no-store" });
      if(!res.ok) throw new Error("settings_fetch_failed");
      const s = await res.json();
      const diets = Array.isArray(s?.diet_systems) ? s.diet_systems : [];

      if (diets.length){
        dietType.innerHTML = diets.map(d=>`<option value="${d.id}">${d.name_ar}</option>`).join("");
        const first = diets[0];
        dietHelp.textContent = first?.description_ar ? `مثال (${first.name_ar}): ${first.description_ar}` : "";
      }

      function handleDietChange(){
        const dId = dietType.value;
        const current = diets.find(d=>String(d.id)===String(dId));
        dietHelp.textContent = current?.description_ar || "";
        customBox.classList.toggle('hidden', dId!=='custom');
      }
      dietType.addEventListener('change', handleDietChange);
      handleDietChange();
    }catch(_){
      // Fail silently
    }
  }

  function ensureSessionOrRedirect(){
    try{
      const sess = JSON.parse(localStorage.getItem("wasfa_session")||"null");
      if(!sess || !sess.auth_token || !sess.session_nonce){
        window.location.replace("login.html");
      }
    }catch(_){ window.location.replace("login.html"); }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    ensureSessionOrRedirect();
    loadPublicSettingsAndBind();
    resetView();
    
    btn.addEventListener('click', ()=>{
      const v=+calorieTarget.value||0;
      if(v<100||v>2000){ setError("أدخل سعرات بين 100 و 2000"); return; }
      if(dietType.value==='custom'){
        const p=+customProtein.value||0, c=+customCarbs.value||0, f=+customFat.value||0;
        if(p<=0 && c<=0 && f<=0){ setError("أدخل قيم الماكروز للمخصص (بروتين/كارب/دهون)."); return; }
      }
      resetView(); generate();
    });

    const logoutBtn = $('logoutBtn');
    if (logoutBtn){
      logoutBtn.addEventListener('click', ()=>{
        try{ localStorage.removeItem('wasfa_session'); }catch(_){}
        window.location.replace('https://wasfaone.netlify.app/login.html');
      });
    }
  });
</script>
</body>
</html>
