<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم — WasfaOne Admin</title>
  <style>
    :root { --primary:#ef4444; --muted:#6b7280; --border:#e5e7eb; }
    *{box-sizing:border-box}
    body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji"; margin:0; color:#0f172a; background:#fff;}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}
    .container{max-width:1100px;margin:0 auto;padding:1rem}
    .title{font-weight:800;font-size:1.35rem}
    nav.tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.75rem}
    nav.tabs button{padding:.5rem .9rem;border-radius:999px;border:1px solid var(--border);background:#fff;color:#111827;cursor:pointer}
    nav.tabs button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    section.tab{display:none}
    section.tab.active{display:block}

    /* cards / layout */
    .card{border:1px solid var(--border);border-radius:14px;padding:1rem}
    .grid{display:grid;gap:1rem}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}

    /* inputs */
    .input{border:1px solid var(--border);border-radius:12px;padding:.6rem .8rem;width:100%}
    .select{border:1px solid var(--border);border-radius:12px;padding:.55rem .65rem;background:#fff;width:100%}
    .btn{border:1px solid var(--border);border-radius:12px;padding:.5rem .9rem;background:#fff;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn-danger{background:#991b1b;color:#fff;border-color:#991b1b}
    .btn-muted{color:#111827;background:#f3f4f6}
    .row-input{width:100%;border:1px solid var(--border);border-radius:8px;padding:.35rem .5rem}

    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{font-weight:700;font-size:.9rem;color:#111827;padding:.6rem;border-bottom:1px solid var(--border);text-align:right}
    tbody td{padding:.5rem;border-bottom:1px solid #f3f4f6;vertical-align:middle}

    .hint{color:var(--muted);font-size:.85rem}
    .mt{margin-top:1rem}
    .mb{margin-bottom:1rem}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="title">لوحة التحكم — WasfaOne</div>
      <div class="hint">أدخل كلمة مرور الأدمن عند الطلب — تُحفظ محليًا (LocalStorage).</div>
      <nav class="tabs" id="tabs">
        <button data-tab="tab-users" class="active">المستخدمون</button>
        <button data-tab="tab-settings">الإعدادات</button>
        <button data-tab="tab-recipes">الوصفات</button>
        <button data-tab="tab-logs">السجلات</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- ============ تبويب إدارة المستخدمين ============ -->
    <section id="tab-users" class="tab active">
      <div class="grid">
        <div class="card">
          <h2 class="mb" style="font-size:1.15rem;font-weight:800">إدارة المستخدمين</h2>

          <!-- إنشاء مستخدم جديد -->
          <form id="createUserForm" class="grid grid-3">
            <div><input required name="name" placeholder="الاسم" class="input" /></div>
            <div><input required name="email" placeholder="البريد" type="email" class="input" /></div>
            <div><input required name="password" placeholder="كلمة السر" class="input" /></div>
            <div>
              <label class="hint" style="display:block;margin-bottom:.25rem">إذا كان البريد موجودًا</label>
              <label style="display:flex;gap:.5rem;align-items:center"><input type="checkbox" name="upsert"/> حدِّث المستخدم بدلًا من الإنشاء</label>
            </div>
            <div>
              <select name="status" class="select">
                <option value="active">active</option>
                <option value="suspended">suspended</option>
              </select>
            </div>
            <div><label class="hint">تاريخ البداية</label><input name="start_date" type="date" class="input" /></div>
            <div><label class="hint">تاريخ النهاية</label><input name="end_date" type="date" class="input" /></div>
            <div><button class="btn btn-primary" type="submit">حفظ المستخدم الجديد</button></div>
          </form>

          <!-- جدول المستخدمين -->
          <div class="mt">
            <div class="hint mb">قائمة المستخدمين الحالية</div>
            <div class="card" style="padding:0">
              <div style="overflow-x:auto">
                <table>
                  <thead>
                    <tr>
                      <th>الاسم</th>
                      <th>البريد</th>
                      <th>الحالة</th>
                      <th>البداية</th>
                      <th>النهاية</th>
                      <th>عمليات</th>
                    </tr>
                  </thead>
                  <tbody id="usersTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ تبويب الإعدادات (كامل حسب settings.json) ============ -->
    <section id="tab-settings" class="tab">
      <div class="grid">
        <div class="card">
          <h2 class="mb" style="font-size:1.15rem;font-weight:800">الإعدادات العامة</h2>
          <div class="hint mb">تحرير <code>data/settings.json</code>: الشعار، بيانات التواصل، الأنظمة الغذائية، الصور، النص البديل.</div>

          <!-- Branding -->
          <h3 class="mb" style="font-size:1rem;font-weight:700">الهوية (Branding)</h3>
          <form id="brandingForm" class="grid grid-3 mb">
            <div>
              <label class="hint">الاسم (AR)</label>
              <input name="site_name_ar" class="input" />
            </div>
            <div>
              <label class="hint">الاسم (EN)</label>
              <input name="site_name_en" class="input" />
            </div>
            <div>
              <label class="hint">رابط الشعار (Logo URL)</label>
              <input name="logo_url" class="input" />
            </div>
          </form>

          <!-- Contact -->
          <h3 class="mb" style="font-size:1rem;font-weight:700">التواصل (Contact)</h3>
          <form id="contactForm" class="grid grid-3 mb">
            <div>
              <label class="hint">رقم الهاتف المعروض</label>
              <input name="phone_display" class="input" />
            </div>
            <div>
              <label class="hint">رابط واتساب</label>
              <input name="whatsapp_link" class="input" />
            </div>
            <div>
              <label class="hint">البريد</label>
              <input name="email" type="email" class="input" />
            </div>
            <div>
              <label class="hint">Instagram</label>
              <input name="instagram" class="input" />
            </div>
            <div>
              <label class="hint">TikTok</label>
              <input name="tiktok" class="input" />
            </div>
            <div>
              <label class="hint">YouTube</label>
              <input name="youtube" class="input" />
            </div>
          </form>

          <!-- Diet systems -->
          <h3 class="mb" style="font-size:1rem;font-weight:700">الأنظمة الغذائية</h3>
          <div class="hint">أضف/عدّل عناصر القائمة (AR/EN + وصف).</div>
          <div id="dietsList" class="mb"></div>
          <button id="addDietBtn" class="btn">+ إضافة نظام غذائي</button>

          <!-- Images -->
          <h3 class="mb mt" style="font-size:1rem;font-weight:700">الصور (URLs)</h3>
          <div id="imagesList" class="mb"></div>

          <!-- Images meta (alts) -->
          <h3 class="mb mt" style="font-size:1rem;font-weight:700">Alt للنصوص البديلة</h3>
          <div id="imagesMetaList" class="mb"></div>

          <div class="mt">
            <button id="saveSettingsBtn" class="btn btn-primary">حفظ الإعدادات</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ تبويب الوصفات (عرض مرجعي) ============ -->
    <section id="tab-recipes" class="tab">
      <div class="grid">
        <div class="card">
          <h2 class="mb" style="font-size:1.15rem;font-weight:800">الوصفات</h2>
          <p class="hint">قسم استعراضي — أدرج/أوصل بوظائفك الخاصة إذا كانت متوفّرة.</p>
          <div id="recipesEmpty" class="hint">لا توجد عناصر للعرض حاليًا.</div>
        </div>
      </div>
    </section>

    <!-- ============ تبويب السجلات (قراءة فقط) ============ -->
    <section id="tab-logs" class="tab">
      <div class="grid">
        <div class="card">
          <h2 class="mb" style="font-size:1.15rem;font-weight:800">السجلات</h2>
          <p class="hint">لعرض سجلات النظام إن توفّرت واجهة API مناسبة.</p>
          <pre id="logsBox" style="white-space:pre-wrap; background:#0b1020; color:#e5e7eb; padding:1rem; border-radius:12px; min-height:120px">(لا توجد سجلات)</pre>
        </div>
      </div>
    </section>
  </main>

  <script>
  (function(){
    // ============ Tab switching ============
    const tabsNav = document.getElementById('tabs');
    const tabButtons = Array.from(tabsNav.querySelectorAll('button'));
    const tabSections = Array.from(document.querySelectorAll('section.tab'));
    function activateTab(id){
      tabButtons.forEach(b=> b.classList.toggle('active', b.dataset.tab===id));
      tabSections.forEach(s=> s.classList.toggle('active', s.id===id));
    }
    tabsNav.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-tab]');
      if(!btn) return;
      activateTab(btn.dataset.tab);
    });

    // ============ Admin Key handling ============
    const ADMIN_KEY_STORAGE = 'wasfa_admin_key';
    let ADMIN_KEY = localStorage.getItem(ADMIN_KEY_STORAGE) || '';
    async function promptAdminKey(){
      if(!ADMIN_KEY){
        ADMIN_KEY = prompt('أدخل كلمة مرور الأدمن:');
        if(!ADMIN_KEY) throw new Error('admin_key_required');
        localStorage.setItem(ADMIN_KEY_STORAGE, ADMIN_KEY);
      }
    }

    // ============ Helpers ============
    function el(tag, attrs={}, children=[]) {
      const e = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==='class') e.className = v; else if(k==='text') e.textContent=v; else e.setAttribute(k,v);
      });
      children.forEach(c=> e.appendChild(c));
      return e;
    }
    async function api(path, method='GET', body){
      await promptAdminKey();
      const res = await fetch('/.netlify/functions/' + path, {
        method,
        headers: { 'content-type':'application/json', 'x-admin-key': ADMIN_KEY },
        body: body? JSON.stringify(body): undefined
      });
      if(res.status===401){ localStorage.removeItem(ADMIN_KEY_STORAGE); ADMIN_KEY=''; throw new Error('unauthorized'); }
      let data = {};
      try{ data = await res.json(); } catch(_){ /* ignore */ }
      if(!res.ok || data.ok===false){ throw new Error(data.error||('request_failed_'+res.status)); }
      return data;
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // ============ Users CRUD ============
    const tbody = document.getElementById('usersTbody');
    let currentUsers = []; // ذاكرة لسرعة التحقق من التكرار

    async function loadUsers(){
      try{
        const { users } = await api('adminUsers');
        renderUsers(Array.isArray(users)? users: []);
      }catch(err){ alert('فشل تحميل المستخدمين: '+ err.message); }
    }

    function rowTemplate(u){
      const tr = document.createElement('tr');
      tr.dataset.email = u.email;
      tr.innerHTML = `
        <td><input class="row-input" name="name" value="${escapeHtml(u.name||'')}" /></td>
        <td><input class="row-input" name="email" value="${escapeHtml(u.email||'')}" disabled /></td>
        <td>
          <select class="row-input" name="status">
            <option value="active" ${u.status==='active'? 'selected':''}>active</option>
            <option value="suspended" ${u.status==='suspended'? 'selected':''}>suspended</option>
          </select>
        </td>
        <td><input class="row-input" name="start_date" type="date" value="${u.start_date||''}" /></td>
        <td><input class="row-input" name="end_date" type="date" value="${u.end_date||''}" /></td>
        <td style="display:flex; gap:.4rem; flex-wrap:wrap">
          <button class="btn js-edit">تعديل</button>
          <button class="btn btn-primary js-save hidden">حفظ</button>
          <button class="btn btn-muted js-cancel hidden">إلغاء</button>
          <button class="btn js-reset">إعادة ربط</button>
          <button class="btn btn-danger js-delete">حذف</button>
        </td>`;
      toggleRowEdit(tr, false);
      attachRowHandlers(tr);
      return tr;
    }

    function toggleRowEdit(tr, editing){
      tr.querySelectorAll('input[name="name"], select[name="status"], input[name="start_date"], input[name="end_date"]').forEach(el=>{
        el.disabled = !editing;
      });
      tr.querySelector('.js-edit').classList.toggle('hidden', editing);
      tr.querySelector('.js-save').classList.toggle('hidden', !editing);
      tr.querySelector('.js-cancel').classList.toggle('hidden', !editing);
    }

    function collectRow(tr){
      const get = (n)=> tr.querySelector(`[name="${n}"]`)?.value ?? null;
      return {
        email: get('email'),
        name: get('name'),
        status: tr.querySelector('[name="status"]').value,
        start_date: get('start_date') || null,
        end_date: get('end_date') || null
      };
    }

    function attachRowHandlers(tr){
      tr.querySelector('.js-edit').addEventListener('click', ()=> toggleRowEdit(tr, true));
      tr.querySelector('.js-cancel').addEventListener('click', ()=> { toggleRowEdit(tr, false); loadUsers(); });
      tr.querySelector('.js-save').addEventListener('click', async ()=>{
        try{
          const payload = collectRow(tr);
          await api('adminUsers','PUT', payload);
          toggleRowEdit(tr, false);
          await loadUsers();
          alert('تم الحفظ');
        }catch(err){ alert('فشل الحفظ: '+ err.message); }
      });
      tr.querySelector('.js-delete').addEventListener('click', async ()=>{
        if(!confirm('حذف المستخدم؟')) return;
        try{ await api('adminUsers','DELETE', { email: tr.dataset.email }); tr.remove(); }
        catch(err){ alert('فشل الحذف: '+ err.message); }
      });
      tr.querySelector('.js-reset').addEventListener('click', async ()=>{
        try{ await api('adminUsers?action=resetDevice','POST', { email: tr.dataset.email }); alert('تمت إعادة ربط الجهاز.'); }
        catch(err){ alert('فشل العملية: '+ err.message); }
      });
    }

    function renderUsers(list){
      currentUsers = Array.isArray(list)? list: [];
      tbody.innerHTML = '';
      currentUsers.forEach(u => tbody.appendChild(rowTemplate(u)));
    }

    // Create new user
    document.getElementById('createUserForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const form = e.currentTarget;
      const fd = new FormData(form);
      const email = (fd.get('email')||'').toString().trim().toLowerCase();
      const body = {
        name: (fd.get('name')||'').toString().trim(),
        email,
        password: (fd.get('password')||'').toString(),
        status: (fd.get('status')||'active').toString(),
        start_date: fd.get('start_date')||null,
        end_date: fd.get('end_date')||null,
        device_fingerprint: null,
        session_nonce: null,
        lock_reason: null
      };
      const upsert = fd.get('upsert') === 'on';
      const exists = currentUsers.some(u => (u.email||'').toLowerCase() === email);
      try{
        if(exists && !upsert){
          alert('هذا البريد موجود مسبقًا. ضع علامة "حدّث المستخدم بدلًا من الإنشاء" أو غيّر البريد.');
          return;
        }
        if(exists && upsert){
          await api('adminUsers','PUT', body);
        } else {
          await api('adminUsers','POST', body);
        }
        form.reset();
        await loadUsers();
        alert('تم الحفظ');
      }catch(err){ alert('فشل حفظ المستخدم: '+ err.message); }
    });

    // Settings loading & saving
    let currentSettings = null;

    async function loadSettings(){
      try{
        const { settings } = await api('adminSettings');
        currentSettings = settings || {};
        renderBranding();
        renderContact();
        renderDiets();
        renderImages();
        renderImagesMeta();
      }catch(err){ alert('فشل تحميل الإعدادات: '+err.message); }
    }

    function renderBranding(){
      const f = document.getElementById('brandingForm');
      const b = currentSettings.branding || {};
      f.site_name_ar.value = b.site_name_ar || '';
      f.site_name_en.value = b.site_name_en || '';
      f.logo_url.value = b.logo_url || '';
    }
    function renderContact(){
      const f = document.getElementById('contactForm');
      const c = currentSettings.contact || {};
      f.phone_display.value = c.phone_display || '';
      f.whatsapp_link.value = c.whatsapp_link || '';
      f.email.value = c.email || '';
      const s = (c.social || {});
      f.instagram.value = s.instagram || '';
      f.tiktok.value = s.tiktok || '';
      f.youtube.value = s.youtube || '';
    }

    function dietItemRow(d){
      const wrap = el('div', { class:'card', style:'margin:.5rem 0;' });
      wrap.appendChild(el('div', { class:'grid grid-3' }, [
        el('div',{},[el('label',{class:'hint',text:'ID'}), el('input',{class:'input','data-k':'id', value: d.id||''})]),
        el('div',{},[el('label',{class:'hint',text:'الاسم (AR)'}), el('input',{class:'input','data-k':'name_ar', value: d.name_ar||''})]),
        el('div',{},[el('label',{class:'hint',text:'Name (EN)'}), el('input',{class:'input','data-k':'name_en', value: d.name_en||''})]),
      ]));
      wrap.appendChild(el('div', { class:'grid' }, [
        el('div',{},[el('label',{class:'hint',text:'الوصف (AR)'}), el('textarea',{class:'input','data-k':'description_ar'},[])]),
        el('div',{},[el('label',{class:'hint',text:'Description (EN)'}), el('textarea',{class:'input','data-k':'description_en'},[])]),
      ]));
      wrap.querySelector('[data-k="description_ar"]').value = d.description_ar||'';
      wrap.querySelector('[data-k="description_en"]').value = d.description_en||'';
      const tools = el('div', { class:'mt' }, [
        el('button',{class:'btn btn-danger',text:'حذف'})
      ]);
      tools.querySelector('button').addEventListener('click',()=>{ wrap.remove(); });
      wrap.appendChild(tools);
      return wrap;
    }

    function renderDiets(){
      const host = document.getElementById('dietsList'); host.innerHTML='';
      (currentSettings.diet_systems||[]).forEach(d=> host.appendChild(dietItemRow(d)));
      document.getElementById('addDietBtn').onclick = ()=>{
        host.appendChild(dietItemRow({ id:'', name_ar:'', name_en:'', description_ar:'', description_en:'' }));
      };
    }

    function imagesRow(k,v){
      const row = el('div', { class:'grid grid-3', style:'margin:.4rem 0;' }, [
        el('input',{class:'input','data-k':'key', value:k}),
        el('input',{class:'input','data-k':'val', value:v}),
        el('button',{class:'btn btn-danger',text:'حذف'})
      ]);
      row.querySelector('button').addEventListener('click',()=> row.remove());
      return row;
    }
    function renderImages(){
      const host = document.getElementById('imagesList'); host.innerHTML='';
      const imgs = currentSettings.images || {};
      Object.keys(imgs).forEach(k=> host.appendChild(imagesRow(k, imgs[k])));
      const add = el('button',{class:'btn',text:'+ إضافة صورة'});
      add.addEventListener('click',()=> host.appendChild(imagesRow('', '')));
      host.appendChild(add);
    }

    function metaRow(k, ar, en){
      const row = el('div', { class:'grid grid-3', style:'margin:.4rem 0;' }, [
        el('input',{class:'input','data-k':'key', value:k}),
        el('input',{class:'input','data-k':'ar', value:ar||''}),
        el('input',{class:'input','data-k':'en', value:en||''})
      ]);
      return row;
    }
    function renderImagesMeta(){
      const host = document.getElementById('imagesMetaList'); host.innerHTML='';
      const meta = currentSettings.images_meta || {};
      Object.keys(meta).forEach(k=> host.appendChild(metaRow(k, meta[k]?.alt_ar, meta[k]?.alt_en)));
      const add = el('button',{class:'btn',text:'+ إضافة Alt'});
      add.addEventListener('click',()=> host.appendChild(metaRow('', '', '')));
      host.appendChild(add);
    }

    function collectSettings(){
      // branding
      const b = document.getElementById('brandingForm');
      const branding = {
        site_name_ar: b.site_name_ar.value.trim(),
        site_name_en: b.site_name_en.value.trim(),
        logo_url: b.logo_url.value.trim()
      };
      // contact
      const cf = document.getElementById('contactForm');
      const contact = {
        phone_display: cf.phone_display.value.trim(),
        whatsapp_link: cf.whatsapp_link.value.trim(),
        email: cf.email.value.trim(),
        social: {
          instagram: cf.instagram.value.trim(),
          tiktok: cf.tiktok.value.trim(),
          youtube: cf.youtube.value.trim()
        }
      };
      // diets
      const dietsHost = document.getElementById('dietsList');
      const diet_systems = Array.from(dietsHost.querySelectorAll('.card')).map(card=>{
        const get = (sel)=> card.querySelector(`[data-k="${sel}"]`).value.trim();
        return { id:get('id'), name_ar:get('name_ar'), name_en:get('name_en'), description_ar:get('description_ar'), description_en:get('description_en') };
      }).filter(d=> d.id);
      // images
      const images = {};
      document.querySelectorAll('#imagesList [data-k="key"]').forEach((kInput, i)=>{
        const v = document.querySelectorAll('#imagesList [data-k="val"]')[i];
        const key = kInput.value.trim(); const val = v.value.trim();
        if(key && val) images[key] = val;
      });
      // meta
      const images_meta = {};
      document.querySelectorAll('#imagesMetaList [data-k="key"]').forEach((kInput, i)=>{
        const ar = document.querySelectorAll('#imagesMetaList [data-k="ar"]')[i];
        const en = document.querySelectorAll('#imagesMetaList [data-k="en"]')[i];
        const key = kInput.value.trim();
        if(key) images_meta[key] = { alt_ar: ar.value.trim(), alt_en: en.value.trim() };
      });
      return { branding, contact, diet_systems, images, images_meta };
    }

    document.getElementById('saveSettingsBtn').addEventListener('click', async ()=>{
      try{
        const payload = collectSettings();
        await api('adminSettings','PUT', payload);
        await loadSettings();
        alert('تم حفظ الإعدادات');
      }catch(err){ alert('فشل حفظ الإعدادات: '+ err.message); }
    });

    document.addEventListener('DOMContentLoaded', ()=>{ loadUsers(); loadSettings(); });
  })();
  </script>
</body>
</html>
