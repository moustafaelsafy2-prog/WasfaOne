<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wasfa | وصفة</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap');

    :root{
      --ink:#0f172a; --muted:#64748b; --brand:#ef4444; --brand-soft:#fef2f2;
      --soft-bg:#f8fafc; --line:#e2e8f0; --success:#22c55e; --error:#ef4444; --info:#3b82f6;
    }

    *{ box-sizing:border-box }
    html{ scroll-behavior:smooth }
    body{
      font-family:'Cairo',sans-serif; background:var(--soft-bg); color:var(--ink);
      min-height:100vh; overflow-x:hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{ max-width:1080px; margin-inline:auto }
    .card{ background:#fff; border:1px solid var(--line); border-radius:28px; padding:28px; box-shadow:0 10px 15px -3px rgba(15,23,42,.05), 0 4px 6px -4px rgba(15,23,42,.05) }
    .divider{ height:1px; background:linear-gradient(to left, transparent, var(--line), transparent); margin:24px 0 }
    .area{ display:grid; grid-template-columns:.8fr 1.2fr; gap:28px; align-items:start }
    @media (max-width:1024px){ .area{ grid-template-columns:1fr } }

    .brand-title{
      font-weight:900; color:transparent; background-clip:text; -webkit-background-clip:text;
      background-image:linear-gradient(to right,#b91c1c,var(--brand));
    }

    .form-group{ position:relative }
    .form-label{ display:block; font-weight:600; color:var(--muted); margin-bottom:8px; font-size:.9rem }
    .form-field{
      width:100%; min-height:52px; border:1px solid var(--line); border-radius:16px;
      padding:0 16px; background:#fcfdff; transition:all .2s; box-shadow:0 1px 2px 0 rgba(0,0,0,.03)
    }
    .form-field:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(239,68,68,.1); background:#fff }
    textarea.form-field{ padding:12px 16px }

    #generateBtn{
      border-radius:16px; padding:14px 28px; font-weight:800; color:white;
      background-image:linear-gradient(to top right,var(--brand),#fb7185);
      box-shadow:0 4px 12px rgba(239,68,68,.2), 0 2px 4px rgba(239,68,68,.2); transition:all .2s;
    }
    #generateBtn:hover:not(:disabled){ transform:translateY(-2px); box-shadow:0 8px 18px rgba(239,68,68,.3), 0 4px 8px rgba(239,68,68,.25); filter:brightness(1.05) }
    #generateBtn:disabled{ opacity:.6; cursor:not-allowed }

    .section-title{
      display:flex; align-items:center; gap:12px; font-size:1.75rem; font-weight:900;
      padding-bottom:8px; border-bottom:1px solid var(--line); margin-bottom:1.25rem
    }
    .section-title svg{ width:24px; height:24px; color:var(--brand) }

    .meta{ display:flex; gap:14px; flex-wrap:wrap }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 14px; border:1px solid var(--line); border-radius:999px; background:#fff; font-weight:700; font-size:.9rem }
    .chip svg{ width:18px; height:18px; color:var(--brand) }

    .tl-wrap{ display:flex; gap:12px; flex-wrap:wrap }
    .tl-pill{ flex:1 1 120px; border-radius:18px; padding:12px; border:1px solid; text-align:center; transition:all .2s }
    .tl-pill:hover{ transform:translateY(-3px); box-shadow:0 6px 12px rgba(0,0,0,.06) }
    .tl-pill .name{ display:block; font-weight:800; font-size:14px }
    .tl-pill .grams{ display:block; font-weight:900; font-size:18px; margin-top:4px }
    .tl-energy{ background:#fef2f2; border-color:#f87171; color:#b91c1c }
    .tl-protein{ background:#eff6ff; border-color:#60a5fa; color:#1e40af }
    .tl-carbs{ background:#f0fdf4; border-color:#4ade80; color:#15803d }
    .tl-fat{ background:#fffbeb; border-color:#facc15; color:#a16207 }

    .panel{ position:sticky; top:24px; background:#fff; border:1px solid var(--line); border-radius:22px; padding:22px; box-shadow:0 12px 30px rgba(0,0,0,.04) }
    .ingredient-list li{ position:relative; padding-right:1.5rem; line-height:1.9; margin-bottom:.5rem; color:var(--muted) }
    .ingredient-list li::before{ content:''; position:absolute; right:0; top:10px; width:8px; height:8px; border-radius:50%; background:var(--brand); box-shadow:0 0 8px rgba(239,68,68,.5) }

    .steps-list{ counter-reset:step; position:relative; padding-right:25px; margin-right:15px }
    .steps-list::before{ content:''; position:absolute; right:0; top:16px; bottom:16px; width:2px; background:repeating-linear-gradient(to bottom,var(--line),var(--line) 4px,transparent 4px,transparent 8px); z-index:0 }
    .step{ position:relative; background:#fff; border:1px solid var(--line); border-radius:18px; padding:20px 24px; box-shadow:0 4px 10px rgba(0,0,0,.03); margin-bottom:20px; transition:all .2s }
    .step:hover{ transform:translateX(-5px); border-color:#d1d5db; box-shadow:0 8px 15px rgba(0,0,0,.05) }
    .step::before{
      counter-increment:step; content:counter(step); position:absolute; right:-41px; top:50%; transform:translateY(-50%);
      width:32px; height:32px; border-radius:999px; display:grid; place-items:center; color:#fff; background:var(--brand);
      font-weight:700; border:3px solid #fff; box-shadow:0 0 0 2px var(--brand); z-index:1
    }
    .step p{ margin:0; color:var(--muted); line-height:1.95 }

    .banner{ border:1px dashed; padding:12px 16px; border-radius:16px }
    .banner.amber{ border-color:#f59e0b; background:#fffbeb; color:#92400e }
    .banner.red{ border-color:#f43f5e; background:#fff1f2; color:#be123c }

    .toast{ position:fixed; inset-inline-start:16px; inset-block-start:16px; z-index:50; display:flex; flex-direction:column; gap:8px }
    .toast-item{ background:#111827; color:#fff; padding:12px 18px; border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.25); font-weight:600; transition:all .4s }
    .toast-item.success{ background:#16a34a } .toast-item.error{ background:#dc2626 } .toast-item.info{ background:#2563eb }

    .loader{ border-top-color:var(--brand); animation:spin 1.2s linear infinite; border:3px solid rgba(239,68,68,.2); width:24px; height:24px; border-radius:999px }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    @keyframes fadeInUp{from{opacity:0; transform:translateY(20px)}to{opacity:1; transform:translateY(0)}} .fade-in-up{ animation:fadeInUp .6s ease-out forwards }
    @keyframes popIn{from{opacity:0; transform:translateY(10px) scale(.95)}to{opacity:1; transform:translateY(0) scale(1)}} .status-pop-in{ animation:popIn .5s ease-out forwards }

    /* ===== زر ونافذة المساعد (يمين + أيقونة ذكاء اصطناعي + أنيميشن جذب) ===== */
    .chat-badge{
      position:fixed; bottom:92px; right:22px; z-index:60;
      background:#0ea5e9; color:#fff; font-weight:900; border-radius:14px;
      padding:10px 12px; box-shadow:0 8px 24px rgba(14,165,233,.35);
      display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;
      animation:badgePulse 2.2s ease-in-out infinite;
    }
    .chat-badge svg{ width:20px; height:20px }
    @keyframes badgePulse{
      0%,100%{ transform:translateY(0); box-shadow:0 8px 24px rgba(14,165,233,.35) }
      50%{ transform:translateY(-3px); box-shadow:0 12px 32px rgba(14,165,233,.45) }
    }

    .chat-fab{
      position:fixed; bottom:22px; right:22px; z-index:60;
      display:inline-flex; align-items:center; justify-content:center;
      width:56px; height:56px; border-radius:999px;
      background:linear-gradient(135deg,#111827,#1f2937); color:#fff;
      border:2px solid rgba(255,255,255,.08); box-shadow:0 12px 32px rgba(0,0,0,.25);
      animation:floatY 3s ease-in-out infinite, glow 2s ease-in-out infinite; cursor:pointer;
    }
    .chat-fab svg{ width:26px; height:26px }
    @keyframes floatY{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
    @keyframes glow{0%,100%{box-shadow:0 0 0 0 rgba(99,102,241,.0),0 12px 32px rgba(0,0,0,.25)}50%{box-shadow:0 0 0 10px rgba(99,102,241,.12),0 12px 32px rgba(0,0,0,.25)}}

    .chat-panel{
      position:fixed; bottom:90px; right:22px; z-index:60; width:360px; max-width:calc(100vw - 44px);
      background:#ffffff; border:1px solid var(--line); border-radius:16px; overflow:hidden;
      box-shadow:0 20px 50px rgba(0,0,0,.18); display:none; flex-direction:column;
      animation:fadeInUp .35s ease-out;
    }
    .chat-header{ display:flex; align-items:center; gap:10px; padding:12px; background:#0b63f3; color:#fff }
    .chat-header .title{ font-weight:900; font-size:14px }
    .chat-header .sub{ font-size:12px; opacity:.9 }
    .chat-body{ background:#F3F6FC; height:380px; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:8px }
    .msg{ max-width:80%; padding:10px 12px; border-radius:12px; line-height:1.6; font-weight:600 }
    .msg.me{ background:#DCF8C6; margin-inline-start:auto; border-bottom-right-radius:4px }
    .msg.bot{ background:#fff; margin-inline-end:auto; border-bottom-left-radius:4px }
    .msg .time{ display:block; opacity:.6; font-size:12px; margin-top:4px }
    .chat-input{ display:flex; gap:8px; padding:8px; background:#fff; border-top:1px solid var(--line) }
    .chat-input input{ flex:1; border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none; background:#fff }
    .chat-input button{ border-radius:12px; padding:10px 14px; background:#0b63f3; color:#fff; font-weight:800 }

    .locked{ opacity:.7; pointer-events:none }
    .hint{ font-size:.8rem; color:var(--muted); margin-top:6px } .hint strong{ color:var(--ink) }
  </style>
</head>
<body class="p-4 md:p-8">
  <div id="toast" class="toast"></div>

  <div class="wrap">
    <div class="card mb-8">
      <div class="flex justify-end">
        <button id="logoutBtn" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-[var(--line)] bg-white hover:bg-gray-50 text-[var(--ink)] font-bold transition-colors">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h4a2 2 0 012 2v1"/></svg>
          <span>تسجيل الخروج</span>
        </button>
      </div>

      <div class="text-center">
        <h1 class="brand-title text-4xl md:text-5xl font-black leading-none px-2">Wasfa | وصفة</h1>
        <p class="text-lg text-[var(--muted)] mt-3">التغذية الذكية .. لصحة مثالية</p>
      </div>

      <div class="divider"></div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-4 gap-y-6">
        <div class="form-group">
          <label for="mealType" class="form-label">نوع الوجبة</label>
          <select id="mealType" class="form-field">
            <option>غداء</option><option>فطور</option><option selected>عشاء</option><option>وجبة خفيفة</option><option>شوربة</option><option>سلطة</option><option>حلويات</option>
          </select>
        </div>
        <div class="form-group">
          <label for="cuisine" class="form-label">المطبخ</label>
          <select id="cuisine" class="form-field">
            <option selected>شرق أوسطي</option><option>مطبخ مصري</option><option>مطبخ شامي</option><option>مطبخ خليجي</option><option>مغربي/تونسي/جزائري</option><option>يمني</option><option>تركي</option><option>يوناني</option><option>إيطالي</option><option>إسباني</option><option>فرنسي</option><option>ألماني/نمساوي</option><option>متوسطي (Mediterranean)</option><option>فارسي/إيراني</option><option>هندي</option><option>باكستاني</option><option>أفغاني</option><option>صيني</option><option>ياباني</option><option>كوري</option><option>تايلندي</option><option>فيتنامي</option><option>فلبيني</option><option>مكسيكي</option><option>بيروفي/لاتيني</option><option>أمريكي</option><option>بحري/مأكولات بحرية</option><option>أفريقي/إثيوبي</option><option>عالمي/مبتكر</option>
          </select>
        </div>
        <div class="form-group">
          <label for="dietType" class="form-label">النظام الغذائي</label>
          <select id="dietType" class="form-field"></select>
          <p class="text-xs text-slate-500 mt-1" id="dietHelp"></p>
        </div>
        <div class="form-group">
          <label for="calorieTarget" class="form-label">سعرات الحصة</label>
          <input id="calorieTarget" type="number" min="100" max="2000" step="1" value="550" class="form-field" placeholder="مثال: 500">
          <p id="calorieHint" class="hint"></p>
        </div>
      </div>

      <div id="customMacrosBox" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4 hidden">
        <div class="form-group">
          <label for="customProtein" class="form-label">بروتين (جم/حصة)</label>
          <input id="customProtein" type="number" min="0" step="1" value="30" class="form-field" placeholder="مثال: 30">
        </div>
        <div class="form-group">
          <label for="customCarbs" class="form-label">كربوهيدرات (جم/حصة)</label>
          <input id="customCarbs" type="number" min="0" step="1" value="35" class="form-field" placeholder="مثال: 35">
        </div>
        <div class="form-group">
          <label for="customFat" class="form-label">دهون (جم/حصة)</label>
          <input id="customFat" type="number" min="0" step="1" value="20" class="form-field" placeholder="مثال: 20">
        </div>
        <div class="sm:col-span-3">
          <p class="hint">في <strong>النظام المخصّص</strong> يتم حساب السعرات تلقائيًا من الماكروز: 4×بروتين + 4×كربوهيدرات + 9×دهون.</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="form-group">
          <label for="commonAllergy" class="form-label">حساسية شائعة</label>
          <select id="commonAllergy" class="form-field">
            <option value="">لا يوجد</option><option>حساسية القمح/الجلوتين</option><option>حساسية الألبان/اللاكتوز</option><option>حساسية المكسرات</option><option>حساسية البيض</option><option>حساسية المأكولات البحرية</option><option>حساسية فول الصويا</option>
          </select>
        </div>
        <div class="form-group">
          <label for="customAllergy" class="form-label">حساسيات أخرى (اختياري)</label>
          <input id="customAllergy" type="text" class="form-field" placeholder="الثوم، الفول السوداني …">
        </div>
      </div>

      <div class="mt-4 form-group">
        <label for="availableIngredients" class="form-label">المكوّنات المتاحة لديك (اختياري)</label>
        <textarea id="availableIngredients" class="form-field" rows="3" placeholder="اكتب المكونات مفصولة بفواصل أو أسطر: صدر دجاج، كوسا، فلفل ألوان، زيت زيتون"></textarea>
        <p class="text-xs text-slate-500 mt-1">سنحاول بناء الوصفة اعتمادًا على هذه القائمة مع السماح بإضافات بسيطة ضرورية فقط.</p>
      </div>

      <div id="banner" class="hidden mt-4 text-sm banner"></div>

      <div class="text-center my-6">
        <button id="generateBtn" class="inline-flex items-center gap-3">
          <span>توليد الوصفة الآن</span>
          <span id="loadingIndicator" class="hidden loader"></span>
        </button>
        <p id="statusMsg" class="mt-2 text-sm text-blue-600 hidden"></p>
        <p id="errorMsg" class="mt-2 text-sm text-red-600 hidden"></p>
      </div>

      <div id="resultContainer" class="hidden">
        <div class="divider"></div>
        <div class="mb-4">
          <h2 id="recipeTitle" class="text-3xl md:text-4xl font-black leading-snug"></h2>
          <div class="meta mt-4 text-[var(--muted)]">
            <span class="chip">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span id="timeValue">—</span>
            </span>
            <span class="chip">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              <span id="servingsValue">—</span>
            </span>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
            <span>المعلومات الغذائية</span>
          </h3>
          <div id="tl-wrap" class="tl-wrap"></div>
        </div>
      </div>
    </div>

    <section id="contentArea" class="area mt-8 hidden">
      <aside class="panel">
        <h3 class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 11 4-7"/><path d="m19 11-4-7"/><path d="M2 11h20"/><path d="m3.5 11 1.6 7.4a2 2 0 0 0 2 1.6h9.8c.9 0 1.8-.7 2-1.6l1.7-7.4"/><path d="m9 11 1 9"/></svg>
          <span>المكونات</span>
        </h3>
        <ul id="ingredientsList" class="ingredient-list"></ul>
      </aside>

      <main>
        <h3 class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="10" x2="21" y1="6" y2="6"/><line x1="10" x2="21" y1="12" y2="12"/><line x1="10" x2="21" y1="18" y2="18"/><path d="M4 6h1v4"/><path d="M4 10h2"/><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1.5"/></svg>
          <span>طريقة التحضير</span>
        </h3>
        <div id="preparationSteps" class="steps-list"></div>

        <!-- قسم طريقة التقديم (من الخادم فقط) -->
        <div class="mt-8">
          <h3 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16"/><path d="M10 2v2"/><path d="M14 2v2"/><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 10h8"/><path d="M8 14h6"/></svg>
            <span>طريقة التقديم</span>
          </h3>
          <ul id="servingList" class="ingredient-list"></ul>
        </div>
      </main>
    </section>
  </div>

  <!-- شارة دعوة واضحة للحديث مع المساعد -->
  <div id="chatBadge" class="chat-badge" title="تحدث مع مساعدك الشخصي">
    <!-- أيقونة دماغ/ذكاء -->
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="2" d="M8 6a4 4 0 0 1 8 0v.5A3.5 3.5 0 0 1 19.5 10h.5a4 4 0 1 1 0 8h-1A3 3 0 0 1 16 21H9a3 3 0 0 1-3-3v-1.5A3.5 3.5 0 0 1 2.5 13H2a4 4 0 1 1 0-8h.5A3.5 3.5 0 0 1 6 6.5z"/>
    </svg>
    <span>تحدث مع مساعدك الشخصي</span>
  </div>

  <!-- زر المساعد (يمين) بأيقونة AI -->
  <button id="chatFab" class="chat-fab" aria-label="محادثة المساعد">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="2" d="M12 3a9 9 0 0 0-9 9v6l3-2a9 9 0 1 0 6-13z"/>
      <path stroke-width="2" d="M9 10h.01M15 10h.01M9 14h6"/>
    </svg>
  </button>

  <!-- نافذة دردشة تشبه واتساب -->
  <div id="chatPanel" class="chat-panel">
    <div class="chat-header">
      <div>
        <div class="title">Wasfa Assistant</div>
        <div class="sub">متصل الآن • مساعد الأنظمة الغذائية</div>
      </div>
      <button id="chatClose" title="إغلاق" class="ml-auto text-white/90 hover:text-white">&times;</button>
    </div>
    <div id="chatBody" class="chat-body"></div>
    <div class="chat-input">
      <input id="chatInput" type="text" placeholder="اسأل عن السعرات، الماكروز، الأنظمة… (المساعد متخصص غذائيًا فقط)"/>
      <button id="chatSend">إرسال</button>
    </div>
  </div>

  <!-- فصل الشيفرة في ملف مستقل -->
  <script src="app.js"></script>
</body>
</html>
