<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WasfaOne â€” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;800&family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Styles (Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹) -->
  <link rel="stylesheet" href="/public/assets/styles.css" />

  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --primary:#ef4444; --acc1:#10b981; --acc2:#3b82f6; }
    body { font-family:"Cairo", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Inter", sans-serif; }
    .btn { transition:transform .15s ease, box-shadow .15s ease; }
    .btn:hover { transform: scale(1.02); box-shadow: 0 10px 24px rgba(0,0,0,.08); }
    .card { border:1px solid rgba(148,163,184,.3); border-radius:1rem; background:white; }
    @media (prefers-color-scheme: dark){
      .card{ background:#0f172a; border-color:#1f2a44; }
      body{ color:#e2e8f0; background:#0b1220; }
    }
    .lbl{ display:block; font-size:.9rem; margin-bottom:.25rem; opacity:.9 }
    .inp{ width:100%; border:1px solid rgba(148,163,184,.35); border-radius:.6rem; background:white; padding:.6rem .75rem; outline:none; }
    @media (prefers-color-scheme: dark){
      .inp{ background:#0b1220; border-color:#24324d; color:#e2e8f0; }
    }
  </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100">

  <!-- Header -->
  <header class="border-b border-slate-200/70 dark:border-slate-800/70 sticky top-0 bg-white/70 dark:bg-slate-900/70 backdrop-blur z-10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img id="logoImg" class="h-9 w-auto" alt="Logo" />
        <h1 id="siteTitle" class="font-extrabold text-lg">WasfaOne</h1>
      </div>
      <nav class="hidden md:flex items-center gap-6">
        <a href="/public/index.html#plans" class="text-sm hover:opacity-80">Ø§Ù„Ø®Ø·Ø·</a>
        <a href="/public/privacy.html" class="text-sm hover:opacity-80">Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
      </nav>
      <div class="flex items-center gap-3">
        <a id="whatsappBtn" href="#" target="_blank" class="btn inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-green-600 text-white text-sm">
          <span>WhatsApp</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-10">
    <div class="grid md:grid-cols-2 gap-6 items-stretch">
      <!-- Intro -->
      <section class="card p-6">
        <h2 class="text-2xl font-extrabold mb-2">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ø¹ÙˆØ¯ØªÙƒ ğŸ‘‹</h2>
        <p class="opacity-80 mb-4 text-sm">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©. Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆÙ…Ù†Ø¹ Ø§Ù„Ø¥Ø³Ø§Ø¡Ø©.</p>
        <ul class="space-y-2 text-sm">
          <li>âœ… Ø§Ù„ØªØ²Ø§Ù… ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ø¬Ø±Ø§Ù… Ù„ÙƒÙ„ Ø§Ù„Ù…ÙƒÙˆÙ‘Ù†Ø§Øª</li>
          <li>âœ… Ø­Ø³Ø§Ø¨ Ø³Ø¹Ø±Ø§Øª 4/4/9 Ø¨Ø¯Ù‚Ø©</li>
          <li>âœ… Ø£Ù†Ø¸Ù…Ø© ØºØ°Ø§Ø¦ÙŠØ© ÙˆØ­Ø³Ø§Ø³ÙŠØ§Øª ÙˆÙ…ÙƒÙˆÙ‘Ù†Ø§ØªÙƒ Ø§Ù„Ù…ØªØ§Ø­Ø©</li>
        </ul>
        <a href="/public/index.html#plans" class="mt-4 inline-block text-sm underline underline-offset">Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø·</a>
      </section>

      <!-- Login Form -->
      <section class="card p-6">
        <h2 class="text-xl font-bold mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>

        <div id="status" class="hidden text-sm mb-3 text-emerald-700 dark:text-emerald-200"></div>
        <div id="error" class="hidden text-sm mb-3 text-red-600 dark:text-rose-300"></div>

        <form id="loginForm" class="space-y-4">
          <div>
            <label class="lbl" for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input id="email" type="email" required class="inp" placeholder="you@example.com" />
          </div>
          <div>
            <label class="lbl" for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="password" type="password" required class="inp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" minlength="6" />
          </div>

          <button id="submitBtn" type="submit" class="btn w-full px-4 py-2 rounded-md bg-[color:var(--primary)] text-white font-bold">
            Ø¯Ø®ÙˆÙ„
          </button>

          <p class="text-sm opacity-80 mt-2">
            Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ØŸ
            <a href="/public/signup.html" class="underline underline-offset">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ (ØªØ¬Ø±Ø¨Ø© 7 Ø£ÙŠØ§Ù…)</a>
          </p>
        </form>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-10 border-t border-slate-200 dark:border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-6 text-sm flex items-center justify-between">
      <p id="footerLine">Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£Ùˆ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: 00971502061209 â€” ÙˆØ§ØªØ³Ø§Ø¨/Ø§ØªØµØ§Ù„</p>
      <a id="footerWhatsapp" href="#" target="_blank" class="btn px-3 py-1.5 rounded-md bg-green-600 text-white">WhatsApp</a>
    </div>
  </footer>

  <script>
    // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø´Ø¹Ø§Ø±/Ø§Ø³Ù…/ÙˆØ§ØªØ³Ø§Ø¨) =====
    (async function loadSettings(){
      try{
        const r = await fetch("/data/settings.json?ts="+Date.now(), { cache:"no-store" });
        if(!r.ok) return;
        const s = await r.json();
        const wa = s?.contact?.whatsapp_link || "#";
        document.getElementById("logoImg").src = s?.branding?.logo_url || "";
        document.getElementById("logoImg").alt = s?.images_meta?.hero?.alt_ar || "Ø´Ø¹Ø§Ø±";
        document.getElementById("siteTitle").textContent = s?.branding?.site_name_ar || "ÙˆØµÙØ© ÙˆÙ†";
        document.getElementById("whatsappBtn").href = wa;
        document.getElementById("footerWhatsapp").href = wa;
      }catch(e){ /* ØªØ¬Ø§Ù‡Ù„ */ }
    })();

    // ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Fingerprint + Hash) =====
    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
    }
    async function getDeviceFingerprint(){
      const nav = window.navigator || {};
      const scr = window.screen || {};
      const tz  = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
      const raw = [
        nav.userAgent, nav.language, nav.platform,
        scr.width, scr.height, scr.colorDepth, tz,
        "fp:v1"
      ].join("|");
      return await sha256(raw);
    }

    // ===== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø±Ø³Ø§Ø¦Ù„ =====
    function show(id, msg){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = msg || "";
      el.classList.toggle("hidden", !msg);
    }

    // ===== Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ =====
    function saveSession(data){
      try{
        localStorage.setItem("auth_token", data.token || "");
        localStorage.setItem("session_nonce", data.session_nonce || "");
        localStorage.setItem("user_name", data.name || "");
        localStorage.setItem("user_email", data.email || "");
        // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø·Ø© (Ù‚Ø¯ ØªÙƒÙˆÙ† null)
        if(typeof data.plan !== "undefined" && data.plan !== null) localStorage.setItem("plan", data.plan);
        if(typeof data.trial_expires_at !== "undefined" && data.trial_expires_at !== null) localStorage.setItem("trial_expires_at", data.trial_expires_at);
        if(typeof data.daily_limit !== "undefined" && data.daily_limit !== null) localStorage.setItem("daily_limit", String(data.daily_limit));
        if(typeof data.used_today !== "undefined" && data.used_today !== null) localStorage.setItem("used_today", String(data.used_today));
        if(typeof data.last_reset !== "undefined" && data.last_reset !== null) localStorage.setItem("last_reset", data.last_reset);
      }catch(e){ /* ØªØ¬Ø§Ù‡Ù„ */ }
    }

    // ===== Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ±Ø§Øª Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) =====
    (function greetIfCreated(){
      const qs = new URLSearchParams(location.search);
      if(qs.get("created")==="1"){
        const em = qs.get("email") || "";
        show("status", `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­. Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø±ÙŠØ¯Ùƒ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${em}`);
        history.replaceState({}, "", location.pathname);
      }
    })();

    // ===== Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
    const form = document.getElementById("loginForm");
    const submitBtn = document.getElementById("submitBtn");

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      show("status", "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ...");
      show("error", "");
      submitBtn.disabled = true;
      submitBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ...";

      try{
        const email = document.getElementById("email").value.trim().toLowerCase();
        const password = document.getElementById("password").value;
        if(!email || !password){ throw new Error("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"); }

        const device_fingerprint_hash = await getDeviceFingerprint();

        const res = await fetch("/.netlify/functions/login", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ email, password, device_fingerprint_hash })
        });

        const data = await res.json().catch(()=>({ ok:false, reason:"bad_json" }));

        if(!data.ok){
          // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ØªØ¹ÙˆØ¯ 200 + ok:false â€” Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
          show("status", "");
          const msg = data.message || "ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.";
          show("error", msg);
          return;
        }

        // Ù†Ø¬Ø§Ø­ â€” Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø«Ù… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
        saveSession(data);
        show("status", "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        setTimeout(()=>{ window.location.href = "/public/app.html"; }, 300);

      } catch(err){
        show("status", "");
        show("error", err.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Ø¯Ø®ÙˆÙ„";
      }
    });
  </script>
</body>
</html>
