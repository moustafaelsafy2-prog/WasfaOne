<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WasfaOne — لوحة التحكم</title>

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;800&family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Styles (هوية المشروع) -->
  <link rel="stylesheet" href="/public/assets/styles.css" />
  <meta name="color-scheme" content="light dark" />

  <style>
    :root { --primary:#ef4444; --acc1:#10b981; --acc2:#3b82f6; }
    body { font-family:"Cairo", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Inter", sans-serif; }
    .btn { transition:transform .15s ease, box-shadow .15s ease; }
    .btn:hover { transform: translateY(-1px); box-shadow:0 10px 20px rgba(0,0,0,.08); }
    .card { border:1px solid rgba(148,163,184,.3); border-radius:1rem; background:white; }
    @media (prefers-color-scheme: dark){
      .card{ background:#0f172a; border-color:#1f2a44; }
      body{ color:#e2e8f0; background:#0b1220; }
    }
    .inp, .sel { width:100%; border:1px solid rgba(148,163,184,.35); border-radius:.6rem; background:white; padding:.45rem .6rem; outline:none; font-size:.85rem; }
    @media (prefers-color-scheme: dark){
      .inp, .sel { background:#0b1220; border-color:#24324d; color:#e2e8f0; }
    }
    .tbl th, .tbl td { padding:.5rem .6rem; border-bottom:1px solid rgba(148,163,184,.25); }
    .badge { display:inline-flex; align-items:center; gap:.35rem; font-weight:700; padding:.15rem .5rem; border-radius:.5rem; font-size:.7rem; }
    .b-trial { background:#fee2e2; color:#991b1b; }
    .b-month { background:#dcfce7; color:#14532d; }
    .b-year  { background:#dbeafe; color:#1e3a8a; }
    @media (prefers-color-scheme: dark){
      .b-trial { background:#7f1d1d; color:#fecaca; }
      .b-month { background:#052e16; color:#86efac; }
      .b-year  { background:#172554; color:#bfdbfe; }
    }
    .actions a { text-decoration: underline; font-size:.8rem; opacity:.9 }
    .rowgrid { display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:.5rem; }
    .rowgrid .inp, .rowgrid .sel { font-size:.8rem; }
    .small { font-size:.8rem; opacity:.8 }
    .muted { opacity:.65 }
  </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100">

  <!-- Header -->
  <header class="border-b border-slate-200/70 dark:border-slate-800/70 sticky top-0 bg-white/70 dark:bg-slate-900/70 backdrop-blur z-10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img id="logoImg" class="h-9 w-auto" alt="Logo" />
        <h1 id="siteTitle" class="font-extrabold text-lg">WasfaOne — لوحة التحكم</h1>
      </div>
      <nav class="hidden md:flex items-center gap-6">
        <a href="/public/index.html#plans" class="text-sm hover:opacity-80">الخطط</a>
        <a href="/public/app.html" class="text-sm hover:opacity-80">التطبيق</a>
      </nav>
      <div class="flex items-center gap-3">
        <a id="whatsappBtn" href="#" target="_blank" class="btn inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-green-600 text-white text-sm">
          <span>WhatsApp</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Admin Top Bar -->
  <section class="border-b border-slate-200/70 dark:border-slate-800/70 bg-white/50 dark:bg-slate-900/40">
    <div class="max-w-7xl mx-auto px-4 py-3 grid md:grid-cols-3 gap-3 items-center">
      <div class="flex items-center gap-2">
        <label class="small" for="adminPass">كلمة سر الأدمن</label>
        <input id="adminPass" type="password" class="inp" placeholder="أدخل كلمة سر الأدمن" />
        <button id="saveAdminPass" class="btn px-3 py-1.5 rounded-md bg-[color:var(--primary)] text-white text-sm">حفظ</button>
      </div>
      <div class="small muted">ستُرسل كلمة السر في الهيدر <code>X-Admin-Auth</code> لكل طلب.</div>
      <div class="text-left md:text-right">
        <button id="reloadBtn" class="btn px-3 py-1.5 rounded-md bg-slate-100 dark:bg-slate-800 text-sm">إعادة تحميل المستخدمين</button>
      </div>
    </div>
  </section>

  <!-- Alerts -->
  <div class="max-w-7xl mx-auto px-4">
    <div id="statusBar" class="hidden mt-4 p-3 rounded-md bg-emerald-50 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-200 text-sm"></div>
    <div id="errorBar" class="hidden mt-4 p-3 rounded-md bg-rose-50 text-rose-800 dark:bg-rose-900/30 dark:text-rose-200 text-sm"></div>
  </div>

  <!-- Create User -->
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <section class="card p-4">
      <h2 class="text-lg font-extrabold mb-2">إنشاء مستخدم جديد</h2>
      <div class="rowgrid">
        <input id="c_email" class="inp" placeholder="البريد" />
        <input id="c_password" class="inp" placeholder="كلمة المرور" />
        <input id="c_name" class="inp" placeholder="الاسم (اختياري)" />
        <input id="c_start" class="inp" placeholder="start_date YYYY-MM-DD (اختياري)" />
        <input id="c_end" class="inp" placeholder="end_date YYYY-MM-DD (اختياري)" />
        <select id="c_plan" class="sel">
          <option value="trial">trial</option>
          <option value="monthly">monthly</option>
          <option value="yearly">yearly</option>
        </select>
      </div>
      <div class="rowgrid mt-2">
        <input id="c_trial_expires" class="inp" placeholder="trial_expires_at YYYY-MM-DD (trial فقط)" />
        <input id="c_daily_limit" class="inp" placeholder="daily_limit (trial فقط، رقم)" />
        <input id="c_used_today" class="inp" placeholder="used_today (رقم)" />
        <input id="c_last_reset" class="inp" placeholder="last_reset YYYY-MM-DD" />
        <input id="c_device" class="inp" placeholder="device_fingerprint (اختياري)" />
        <input id="c_status" class="inp" placeholder="status (active/inactive/suspended)" />
      </div>
      <div class="mt-3 flex gap-2">
        <button id="createBtn" class="btn px-3 py-1.5 rounded-md bg-[color:var(--primary)] text-white text-sm">إنشاء</button>
      </div>
    </section>

    <!-- Users Table -->
    <section class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-extrabold">المستخدمون</h2>
        <div class="small muted">تُطبّع التواريخ والحالة على الخادم (Asia/Dubai)</div>
      </div>

      <div class="overflow-x-auto">
        <table class="tbl w-full text-sm">
          <thead>
            <tr class="text-left">
              <th>البريد</th>
              <th>خطة</th>
              <th>نافذة الاشتراك</th>
              <th>التجربة/الحد اليومي</th>
              <th>الحالة</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="usersTbody">
            <!-- rows injected -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="mt-6 border-t border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-6 text-sm flex items-center justify-between">
      <p id="footerLine">للاشتراك أو التجديد: 00971502061209 — واتساب/اتصال</p>
      <a id="footerWhatsapp" href="#" target="_blank" class="btn px-3 py-1.5 rounded-md bg-green-600 text-white">WhatsApp</a>
    </div>
  </footer>

  <script>
    // ===== الهوية (شعار/اسم/واتساب) =====
    (async function branding(){
      try{
        const r = await fetch("/data/settings.json?ts="+Date.now(), { cache:"no-store" });
        if(!r.ok) return;
        const s = await r.json();
        const wa = s?.contact?.whatsapp_link || "#";
        document.getElementById("logoImg").src = s?.branding?.logo_url || "";
        document.getElementById("logoImg").alt = s?.images_meta?.hero?.alt_ar || "شعار";
        document.getElementById("siteTitle").textContent = (s?.branding?.site_name_ar || "وصفة ون") + " — لوحة التحكم";
        document.getElementById("whatsappBtn").href = wa;
        document.getElementById("footerWhatsapp").href = wa;
      }catch(e){}
    })();

    // ===== أدوات =====
    const $ = (id)=>document.getElementById(id);
    const show = (el, msg, ok=true)=>{
      if(!el) return;
      el.textContent = msg || "";
      el.classList.toggle("hidden", !msg);
      if(el.id==="statusBar"){
        el.classList.toggle("bg-emerald-50", !!msg && ok);
        el.classList.toggle("text-emerald-800", !!msg && ok);
        el.classList.toggle("dark:bg-emerald-900/30", !!msg && ok);
        el.classList.toggle("dark:text-emerald-200", !!msg && ok);
      }
      if(el.id==="errorBar"){
        el.classList.toggle("bg-rose-50", !!msg && !ok);
        el.classList.toggle("text-rose-800", !!msg && !ok);
        el.classList.toggle("dark:bg-rose-900/30", !!msg && !ok);
        el.classList.toggle("dark:text-rose-200", !!msg && !ok);
      }
    };
    const statusBar = $("statusBar");
    const errorBar = $("errorBar");
    const ADMIN_FN = "/.netlify/functions/adminUsers";

    function getAdminPass(){
      return sessionStorage.getItem("ADMIN_PW") || "";
    }
    function setAdminPass(pw){
      sessionStorage.setItem("ADMIN_PW", pw || "");
    }

    // ===== تحميل المستخدمين =====
    async function loadUsers(){
      show(statusBar, "جاري تحميل المستخدمين ...", true);
      show(errorBar, "");
      try{
        const res = await fetch(ADMIN_FN, {
          method: "GET",
          headers: { "X-Admin-Auth": getAdminPass() }
        });
        const data = await res.json();
        if(!data.ok){ show(errorBar, data.error || "فشل تحميل المستخدمين", false); show(statusBar,""); return; }
        renderUsers(data.users || []);
        show(statusBar, "تم تحميل المستخدمين ✅", true);
      }catch(e){
        show(errorBar, "تعذر الاتصال بالخادم", false);
      }
    }

    // ===== رسم صفوف المستخدمين =====
    function badge(plan){
      const p = String(plan||"").toLowerCase();
      if (p==="monthly") return '<span class="badge b-month">monthly</span>';
      if (p==="yearly")  return '<span class="badge b-year">yearly</span>';
      return '<span class="badge b-trial">trial</span>';
    }

    function row(u){
      const email = String(u.email||"");
      const plan  = String(u.plan||"trial");
      const start = String(u.start_date||"");
      const end   = String(u.end_date||"");
      const status = String(u.status||"");
      const trial_expires = String(u.trial_expires_at||"");
      const daily_limit = (u.daily_limit===null || typeof u.daily_limit==="undefined") ? "" : String(u.daily_limit);
      const used_today = String(u.used_today||0);
      const last_reset = String(u.last_reset||"");

      return `
      <tr data-email="${email}">
        <td class="align-top">
          <div class="font-bold">${email}</div>
          <div class="small muted">الاسم: ${u.name||"-"}</div>
          <div class="small muted">جهاز: ${u.device_fingerprint? "مرتبط" : "غير مرتبط"}</div>
        </td>
        <td class="align-top">
          <div class="flex items-center gap-2 mb-1">${badge(plan)}</div>
          <div class="rowgrid" style="grid-template-columns:repeat(2,minmax(0,1fr));">
            <select class="sel sel-plan">
              <option ${plan==="trial"?"selected":""} value="trial">trial</option>
              <option ${plan==="monthly"?"selected":""} value="monthly">monthly</option>
              <option ${plan==="yearly"?"selected":""} value="yearly">yearly</option>
            </select>
            <input class="inp in-status" placeholder="status" value="${status}" />
          </div>
        </td>
        <td class="align-top">
          <div class="rowgrid" style="grid-template-columns:repeat(2,minmax(0,1fr));">
            <input class="inp in-start" placeholder="start_date" value="${start}" />
            <input class="inp in-end" placeholder="end_date" value="${end}" />
          </div>
        </td>
        <td class="align-top">
          <div class="rowgrid" style="grid-template-columns:repeat(3,minmax(0,1fr));">
            <input class="inp in-trial" placeholder="trial_expires_at" value="${trial_expires}" />
            <input class="inp in-daily" placeholder="daily_limit (رقم/فارغ للمدفوع)" value="${daily_limit}" />
            <input class="inp in-used" placeholder="used_today" value="${used_today}" />
          </div>
          <div class="rowgrid mt-1" style="grid-template-columns:repeat(2,minmax(0,1fr));">
            <input class="inp in-reset" placeholder="last_reset YYYY-MM-DD" value="${last_reset}" />
            <input class="inp in-device" placeholder="device_fingerprint" value="${u.device_fingerprint||""}" />
          </div>
        </td>
        <td class="align-top">
          <div class="small">lock_reason: ${u.lock_reason||"-"}</div>
          <div class="small">session_nonce: ${u.session_nonce? "✅" : "—"}</div>
          <div class="small">auth_token: ${u.auth_token? "✅" : "—"}</div>
        </td>
        <td class="align-top">
          <div class="actions flex flex-col gap-1">
            <a href="#" data-act="save">حفظ</a>
            <a href="#" data-act="upgrade-monthly">ترقية ➜ شهري</a>
            <a href="#" data-act="upgrade-yearly">ترقية ➜ سنوي</a>
            <a href="#" data-act="set-trial">تفعيل/ضبط تجربة</a>
            <a href="#" data-act="resetdaily">تصفير اليوم</a>
            <a href="#" data-act="resetdevice">فك ربط الجهاز</a>
            <a href="#" data-act="delete" class="text-rose-600">حذف</a>
          </div>
        </td>
      </tr>
      `;
    }

    function renderUsers(list){
      const tbody = $("usersTbody");
      tbody.innerHTML = (list||[]).map(u => row(u)).join("");
      bindRowActions();
    }

    // ===== ربط أزرار الصف =====
    function bindRowActions(){
      const tbody = $("usersTbody");
      tbody.querySelectorAll("tr").forEach(tr=>{
        tr.querySelectorAll("[data-act]").forEach(a=>{
          a.addEventListener("click", (ev)=>{
            ev.preventDefault();
            const act = a.getAttribute("data-act");
            handleRowAction(tr, act);
          });
        });
      });
    }

    function collectRow(tr){
      const email = tr.getAttribute("data-email");
      const sel = (cls)=>tr.querySelector(cls);
      return {
        email,
        plan: sel(".sel-plan")?.value || "trial",
        status: sel(".in-status")?.value || "",
        start_date: sel(".in-start")?.value || "",
        end_date: sel(".in-end")?.value || "",
        trial_expires_at: sel(".in-trial")?.value || "",
        daily_limit: (()=>{
          const v = sel(".in-daily")?.value || "";
          if (v === "" || v.toLowerCase()==="null") return null;
          const n = Number(v);
          return Number.isFinite(n) ? n : null;
        })(),
        used_today: Number(sel(".in-used")?.value || 0),
        last_reset: sel(".in-reset")?.value || "",
        device_fingerprint: sel(".in-device")?.value || ""
      };
    }

    async function handleRowAction(tr, act){
      show(statusBar, "");
      show(errorBar, "");
      const email = tr.getAttribute("data-email");
      const bodyBase = { email };

      try{
        if(act==="save"){
          const p = collectRow(tr);
          const res = await fetch(ADMIN_FN+"?action=update", {
            method:"POST",
            headers: { "Content-Type":"application/json", "X-Admin-Auth": getAdminPass() },
            body: JSON.stringify(p)
          });
          const data = await res.json();
          if(!data.ok) return show(errorBar, data.error || "فشل الحفظ", false);
          show(statusBar, "تم حفظ التعديلات ✅", true);
          await loadUsers();
          return;
        }
        if(act==="upgrade-monthly" || act==="upgrade-yearly"){
          const plan = act==="upgrade-monthly" ? "monthly" : "yearly";
          const res = await fetch(ADMIN_FN+"?action=upgrade", {
            method:"POST",
            headers: { "Content-Type":"application/json", "X-Admin-Auth": getAdminPass() },
            body: JSON.stringify({ email, plan })
          });
          const data = await res.json();
          if(!data.ok) return show(errorBar, data.error || "فشل الترقية", false);
          show(statusBar, `تمت الترقية إلى ${plan} (غير محدود) ✅`, true);
          await loadUsers();
          return;
        }
        if(act==="set-trial"){
          const p = collectRow(tr);
          // ضبط خطة تجربة مع التاريخ والحد اليومي
          const res = await fetch(ADMIN_FN+"?action=setplan", {
            method:"POST",
            headers: { "Content-Type":"application/json", "X-Admin-Auth": getAdminPass() },
            body: JSON.stringify({
              email,
              plan:"trial",
              trial_expires_at: p.trial_expires_at || p.end_date || "",
              daily_limit: (p.daily_limit===null? 2 : p.daily_limit) // تأمين قيمة
            })
          });
          const data = await res.json();
          if(!data.ok) return show(errorBar, data.error || "فشل ضبط التجربة", false);
          show(statusBar, "تم ضبط/تفعيل التجربة ✅", true);
          await loadUsers();
          return;
        }
        if(act==="resetdaily"){
          const res = await fetch(ADMIN_FN+"?action=resetdaily", {
            method:"POST",
            headers: { "Content-Type":"application/json", "X-Admin-Auth": getAdminPass() },
            body: JSON.stringify(bodyBase)
          });
          const data = await res.json();
          if(!data.ok) return show(errorBar, data.error || "فشل تصفير اليوم", false);
          show(statusBar, "تم تصفير عدّاد اليوم ✅", true);
          await loadUsers();
          return;
        }
        if(act==="resetdevice"){
          const res = await fetch(ADMIN_FN+"?action=resetdevice", {
            method:"POST",
            headers: { "Content-Type":"application/json", "X-Admin-Auth": getAdminPass() },
            body: JSON.stringify(bodyBase)
          });
          const data = await res.json();
          if(!data.ok) return show(errorBar, data.error || "فشل فك ربط الجهاز", false);
          show(statusBar, "تم فك ربط الجهاز ✅", true);
          await loadUsers();
          return;
        }
        if(act==="delete"){
          if(!confirm("تأكيد حذف المستخدم؟")) return;
          const res = await fetch(ADMIN_FN, {
            method:"DELETE",
            headers: { "Content-Type":"application/json", "X-Admin-Auth": getAdminPass() },
            body: JSON.stringify(bodyBase)
          });
          const data = await res.json();
          if(!data.ok) return show(errorBar, data.error || "فشل الحذف", false);
          show(statusBar, "تم حذف المستخدم ✅", true);
          await loadUsers();
          return;
        }
      }catch(e){
        show(errorBar, "تعذر تنفيذ الإجراء", false);
      }
    }

    // ===== إنشاء مستخدم جديد =====
    $("createBtn")?.addEventListener("click", async ()=>{
      show(statusBar, "");
      show(errorBar, "");
      try{
        const payload = {
          email: $("c_email").value.trim().toLowerCase(),
          password: $("c_password").value,
          name: $("c_name").value.trim(),
          start_date: $("c_start").value.trim(),
          end_date: $("c_end").value.trim(),
          plan: $("c_plan").value,
          trial_expires_at: $("c_trial_expires").value.trim(),
          daily_limit: (()=>{
            const v = $("c_daily_limit").value.trim();
            if (v==="" || v.toLowerCase()==="null") return null;
            const n = Number(v);
            return Number.isFinite(n) ? n : null;
          })(),
          used_today: Number($("c_used_today").value||0),
          last_reset: $("c_last_reset").value.trim(),
          device_fingerprint: $("c_device").value.trim(),
          status: $("c_status").value.trim()
        };

        const res = await fetch(ADMIN_FN+"?action=create", {
          method:"POST",
          headers: { "Content-Type":"application/json", "X-Admin-Auth": getAdminPass() },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(!data.ok) return show(errorBar, data.error || "فشل إنشاء المستخدم", false);
        show(statusBar, "تم إنشاء المستخدم ✅", true);
        await loadUsers();
      }catch(e){
        show(errorBar, "تعذر إنشاء المستخدم", false);
      }
    });

    // ===== حفظ كلمة سر الأدمن + إعادة تحميل =====
    $("saveAdminPass")?.addEventListener("click", ()=>{
      const pw = $("adminPass").value;
      setAdminPass(pw);
      show(statusBar, "تم حفظ كلمة سر الأدمن لهذه الجلسة ✅", true);
      loadUsers();
    });

    $("reloadBtn")?.addEventListener("click", loadUsers);

    // ===== تهيئة الصفحة =====
    (function init(){
      const pw = sessionStorage.getItem("ADMIN_PW") || "";
      if(pw) $("adminPass").value = pw;
      loadUsers();
    })();
  </script>
</body>
</html>
