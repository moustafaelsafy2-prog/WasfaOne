<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>مُنشئ الوصفات بالذكاء الاصطناعي</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Cairo:wght@200..1000&display=swap');
    body{font-family:'Cairo','Inter',sans-serif;background:#f7f7f9;min-height:100vh;overflow-x:hidden}

    /* ===== Card + Ingredients ===== */
    .recipe-card{box-shadow:0 10px 30px rgba(0,0,0,.08);transition:transform .3s; padding-bottom:2rem}
    .recipe-card:hover{transform:translateY(-2px)}
    .ingredient-list li{position:relative;padding-right:1.5rem;line-height:1.9;margin-bottom:.6rem;font-size:1rem}
    .ingredient-list li::before{content:'•';position:absolute;right:0;color:#ef4444;font-weight:bold}

    /* ===== Steps (clean cards with numbered badge) ===== */
    .steps-list{counter-reset:step-counter}
    .prep-step{
      position:relative;background:#fff;border:1px solid #eef0f3;border-radius:14px;
      padding:14px 16px 14px 56px;margin:10px 0;line-height:1.9;box-shadow:0 4px 16px rgba(0,0,0,.03)
    }
    .prep-step:nth-child(odd){background:#fcfcfd}
    .prep-step::before{
      counter-increment:step-counter; content:counter(step-counter);
      position:absolute; right:14px; top:14px; width:32px; height:32px; border-radius:999px;
      background:#ef4444; color:#fff; display:grid; place-items:center; font-weight:800; font-size:.95rem;
      box-shadow:0 2px 6px rgba(239,68,68,.35)
    }
    .step-title{margin:0 0 6px 0; font-size:1.05rem; font-weight:700; color:#111827}
    .step-text{margin:0; color:#374151; font-size:1rem; word-break:break-word}

    /* ===== Loader ===== */
    .loader{border-top-color:#ef4444; animation:spin 1.5s linear infinite; border:2px dashed; width:20px;height:20px;border-radius:999px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* ===== Nutrition Facts (FDA-like) ===== */
    .nf-box{background:#fff;border:2px solid #111;padding:10px 12px;border-radius:12px}
    .nf-title{font-weight:900;font-size:22px;border-bottom:8px solid #111; padding-bottom:6px;margin-bottom:6px;letter-spacing:.2px}
    .nf-sub{display:flex;justify-content:space-between;font-weight:800;font-size:16px;border-bottom:2px solid #111;padding:6px 0}
    .nf-line{display:flex;justify-content:space-between;border-top:1px solid #111;padding:6px 0;font-weight:700}
    .nf-line .val{font-weight:900}
    .nf-cal{display:flex;justify-content:space-between;align-items:baseline;border-bottom:8px solid #111;padding:8px 0}
    .nf-cal .big{font-size:40px;font-weight:900;line-height:1}
    .nf-foot{border-top:2px solid #111;margin-top:8px;padding-top:6px;font-size:12px;color:#4b5563}

    /* ===== Traffic Light (UK-style, adapted) ===== */
    .tl-wrap{display:flex;gap:8px;flex-wrap:wrap}
    .tl-pill{flex:1 1 110px;border-radius:14px;padding:8px 10px;border:2px solid #111;color:#111;text-align:center}
    .tl-pill .name{display:block;font-weight:800;font-size:14px}
    .tl-pill .grams{display:block;font-weight:900;font-size:18px;margin-top:4px}
    .tl-pill .flag{display:inline-block;margin-top:6px;padding:2px 8px;border-radius:999px;font-weight:800;font-size:12px;background:#fff}
    .tl-low{background:#e7f7e7;border-color:#0f5132}       /* أخضر */
    .tl-med{background:#fff7e6;border-color:#b45309}       /* أصفر */
    .tl-high{background:#ffecec;border-color:#b91c1c}      /* أحمر */

    /* Mobile tweaks */
    select,input[type="number"],input[type="text"]{min-height:48px}
    @media (max-width:1023px){
      .recipe-card .grid{display:flex;flex-direction:column}
      .recipe-card .order-1{order:1}
      .recipe-card .order-2{order:2}
      .prep-step{padding:12px 12px 12px 52px}
      .step-text{font-size:.98rem}
    }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="max-w-5xl mx-auto">
    <!-- Header -->
    <header class="text-center mb-8">
      <h1 class="text-4xl font-extrabold text-red-600 mb-2">مُولِّد الوصفات الذكي</h1>
      <p class="text-gray-600 text-lg">اختر تفضيلاتك الغذائية ودع الذكاء الاصطناعي يُحضّر لك وجبتك المثالية.</p>
    </header>

    <!-- Form -->
    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 border-gray-100">حدد مواصفات الوجبة والنظام الغذائي</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div>
          <label for="mealType" class="block text-sm font-medium text-gray-700 mb-1">نوع الوجبة</label>
          <select id="mealType" class="mt-1 block w-full pl-3 pr-10 py-3 border rounded-md">
            <option value="غداء">غداء</option>
            <option value="فطور">فطور</option>
            <option value="عشاء" selected>عشاء</option>
            <option value="وجبة خفيفة">وجبة خفيفة</option>
          </select>
        </div>
        <div>
          <label for="cuisine" class="block text-sm font-medium text-gray-700 mb-1">المطبخ</label>
          <select id="cuisine" class="mt-1 block w-full pl-3 pr-10 py-3 border rounded-md">
            <option value="شرق أوسطي" selected>شرق أوسطي</option>
            <option value="مطبخ مصري">مطبخ مصري</option>
            <option value="مطبخ شامي">مطبخ شامي</option>
            <option value="مطبخ خليجي">مطبخ خليجي</option>
            <option value="مطبخ مغربي/تونسي/جزائري">مغربي/تونسي/جزائري</option>
            <option value="مطبخ يمني">مطبخ يمني</option>
            <option value="إيطالي">إيطالي</option>
            <option value="آسيوي">آسيوي</option>
            <option value="عالمي/مبتكر">عالمي/مبتكر</option>
          </select>
        </div>
        <div>
          <label for="dietType" class="block text-sm font-medium text-gray-700 mb-1">النظام الغذائي المتبع</label>
          <select id="dietType" class="mt-1 block w-full pl-3 pr-10 py-3 border rounded-md">
            <option value="عادي/متوازن" selected>عادي / متوازن</option>
            <option value="نظام د. محمد سعيد">نظام د. محمد سعيد</option>
            <option value="كيتو">كيتو</option>
            <option value="نباتي (Vegetarian)">نباتي (Vegetarian)</option>
            <option value="فيجن (Vegan)">فيجن (Vegan)</option>
            <option value="قليل الكربوهيدرات">قليل الكربوهيدرات</option>
            <option value="خالي من الجلوتين">خالي من الجلوتين</option>
            <option value="عالي البروتين">عالي البروتين</option>
          </select>
        </div>
        <div>
          <label for="calorieTarget" class="block text-sm font-medium text-gray-700 mb-1">السعرات الحرارية المطلوبة (لكل حصة)</label>
          <input type="number" id="calorieTarget" min="100" max="2000" step="50" value="550" class="mt-1 block w-full px-3 py-3 border rounded-md" placeholder="مثال: 500 سعرة">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <div>
          <label for="commonAllergy" class="block text-sm font-medium text-gray-700 mb-1">الحساسية الغذائية الشائعة</label>
          <select id="commonAllergy" class="mt-1 block w-full pl-3 pr-10 py-3 border rounded-md">
            <option value="">لا يوجد</option>
            <option value="حساسية القمح/الجلوتين">القمح / الجلوتين</option>
            <option value="حساسية الألبان/اللاكتوز">الألبان / اللاكتوز</option>
            <option value="حساسية المكسرات">المكسرات</option>
            <option value="حساسية البيض">البيض</option>
            <option value="حساسية المأكولات البحرية">المأكولات البحرية</option>
            <option value="حساسية فول الصويا">فول الصويا</option>
          </select>
        </div>
        <div>
          <label for="customAllergy" class="block text-sm font-medium text-gray-700 mb-1">حساسيات أخرى يجب تجنبها (اختياري)</label>
          <input type="text" id="customAllergy" placeholder="الثوم، الفول السوداني ..." class="mt-1 block w-full px-3 py-3 border rounded-md">
        </div>
      </div>

      <div class="mt-6">
        <label for="focus" class="block text-sm font-medium text-gray-700 mb-1">المكون الرئيسي / التركيز (اختياري)</label>
        <input type="text" id="focus" class="mt-1 block w-full px-3 py-3 border rounded-md" placeholder="مثل: دجاج وخضار..." value="وصفة دجاج صحية غنية بالبروتين">
      </div>

      <button id="generateBtn" class="mt-6 w-full flex justify-center items-center py-3 px-4 text-lg font-medium rounded-xl text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition shadow-md hover:shadow-lg disabled:bg-red-400">
        <div id="loadingIndicator" class="hidden loader ml-2"></div>
        توليد الوصفة الآن
      </button>
      <p id="statusMsg" class="mt-3 text-center text-sm text-blue-600 hidden"></p>
      <p id="errorMsg" class="mt-3 text-center text-sm text-red-500 hidden">حدث خطأ. يرجى المحاولة مرة أخرى.</p>
    </div>

    <!-- Output -->
    <div id="recipeOutput" class="recipe-card bg-white p-6 md:p-8 rounded-xl border border-gray-200 hidden">
      <div class="text-center mb-6">
        <h2 id="recipeTitle" class="text-3xl font-extrabold text-gray-900 mb-2"></h2>
        <div class="flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4 sm:space-x-reverse text-gray-500 text-sm font-medium">
          <p class="flex items-center">
            <svg class="w-4 h-4 ml-1 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <span id="timeValue"></span>
          </p>
          <p class="flex items-center">
            <svg class="w-4 h-4 ml-1 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2A3 3 0 005.356 18.143 3 3 0 005 20h5V20m0 0h10a2 2 0 002-2v-2a3 3 0 00-5.356-1.857M10 20v-2a3 3 0 0110.356 1.857 3 3 0 01-10.356 0zM6 10a3 3 0 11-6 0 3 3 0 016 0zM17 4a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span id="servingsValue"></span>
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 border-t pt-6 border-gray-100">
        <!-- Macros + Ingredients -->
        <div class="lg:col-span-1 order-1">
          <!-- Macros summary (existing) -->
          <div class="bg-white p-4 md:p-6 rounded-xl mb-6 flex flex-col items-center border border-gray-100 shadow-sm">
            <h3 class="text-xl font-bold text-red-600 mb-4">القيمة الغذائية (لكل حصة)</h3>
            <div class="mb-6 w-36 h-36 flex flex-col items-center justify-center rounded-full bg-red-100 border-4 border-red-500 shadow-md">
              <div id="caloriesValue" class="text-3xl font-black text-gray-900"></div>
              <div class="text-sm font-medium text-red-600">سعرة حرارية</div>
            </div>
            <div class="w-full grid grid-cols-3 gap-3 text-center">
              <div class="p-2 rounded-lg bg-green-50 border border-green-200">
                <div id="proteinValue" class="text-xl font-bold text-green-700"></div>
                <div class="text-xs font-medium text-gray-600 mt-1">بروتين</div>
              </div>
              <div class="p-2 rounded-lg bg-blue-50 border border-blue-200">
                <div id="carbsValue" class="text-xl font-bold text-blue-700"></div>
                <div class="text-xs font-medium text-gray-600 mt-1">كربوهيدرات</div>
              </div>
              <div class="p-2 rounded-lg bg-yellow-50 border border-yellow-200">
                <div id="fatsValue" class="text-xl font-bold text-yellow-700"></div>
                <div class="text-xs font-medium text-gray-600 mt-1">دهون</div>
              </div>
            </div>
          </div>

          <!-- NEW: Nutrition Facts (FDA-like) -->
          <div class="nf-box mb-6">
            <div class="nf-title">حقائق التغذية</div>
            <div class="nf-sub">
              <span id="nf-servings-text">عدد الحصص: –</span>
              <span id="nf-serving-size">حجم الحصة: —</span>
            </div>
            <div class="nf-cal">
              <span class="font-bold">السعرات</span>
              <span id="nf-calories" class="big">—</span>
            </div>
            <div class="nf-line"><span>إجمالي الدهون</span><span class="val" id="nf-fat">— جم</span></div>
            <div class="nf-line"><span>الكربوهيدرات الإجمالية</span><span class="val" id="nf-carbs">— جم</span></div>
            <div class="nf-line"><span>البروتين</span><span class="val" id="nf-protein">— جم</span></div>
            <div class="nf-foot">* القيم لكل حصة حسب الوصفة المولدة.</div>
          </div>

          <!-- NEW: Traffic-Light badges -->
          <div class="tl-wrap" id="tl-wrap">
            <!-- يتم ملؤها برمجيًا -->
          </div>

          <div class="mt-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 border-gray-100">المكونات:</h3>
            <ul id="ingredientsList" class="ingredient-list pr-4 text-gray-700"></ul>
          </div>
        </div>

        <!-- Steps -->
        <div class="lg:col-span-2 order-2">
          <h3 class="text-2xl font-extrabold text-gray-900 mb-6 border-b pb-2 border-gray-100">طريقة التحضير:</h3>
          <div id="preparationSteps" class="steps-list"></div>
        </div>
      </div>
      <pre id="rawJson" class="hidden"></pre>
    </div>
  </div>

  <script>
    const API_ENDPOINT = "/.netlify/functions/generateRecipe";

    // DOM utils
    const el = id => document.getElementById(id);
    const mealTypeEl=el('mealType'), cuisineEl=el('cuisine'), dietTypeEl=el('dietType'),
          calorieTargetEl=el('calorieTarget'), commonAllergyEl=el('commonAllergy'),
          customAllergyEl=el('customAllergy'), focusEl=el('focus'),
          generateBtn=el('generateBtn'), loadingIndicator=el('loadingIndicator'),
          errorMsg=el('errorMsg'), statusMsg=el('statusMsg'), recipeOutput=el('recipeOutput');
    const recipeTitle=el('recipeTitle'), timeValue=el('timeValue'), servingsValue=el('servingsValue'),
          caloriesValue=el('caloriesValue'), proteinValue=el('proteinValue'),
          carbsValue=el('carbsValue'), fatsValue=el('fatsValue'),
          ingredientsList=el('ingredientsList'), preparationSteps=el('preparationSteps'),
          rawJson=el('rawJson');

    // Nutrition Facts elements
    const nfServingsText=el('nf-servings-text'), nfServingSize=el('nf-serving-size'), nfCalories=el('nf-calories'),
          nfFat=el('nf-fat'), nfCarbs=el('nf-carbs'), nfProtein=el('nf-protein'), tlWrap=el('tl-wrap');

    function show(msg, ok=true){ statusMsg.textContent=msg||""; statusMsg.classList.toggle('hidden',!msg); statusMsg.classList.toggle('text-blue-600',ok); statusMsg.classList.toggle('text-red-600',!ok) }
    function err(msg){ errorMsg.textContent=msg||""; errorMsg.classList.toggle('hidden',!msg) }
    function clearOut(){
      recipeTitle.textContent=""; timeValue.textContent=""; servingsValue.textContent="";
      caloriesValue.textContent=""; proteinValue.textContent=""; carbsValue.textContent=""; fatsValue.textContent="";
      ingredientsList.innerHTML=""; preparationSteps.innerHTML=""; rawJson.textContent="";
      nfServingsText.textContent="عدد الحصص: –"; nfServingSize.textContent="حجم الحصة: —"; nfCalories.textContent="—";
      nfFat.textContent="— جم"; nfCarbs.textContent="— جم"; nfProtein.textContent="— جم";
      tlWrap.innerHTML="";
      recipeOutput.classList.add('hidden');
    }

    // server schema -> view
    function mapServerToView(rec){
      return {
        title: rec.title,
        time: `جاهز في ${rec.total_time_min} دقيقة`,
        servings: `${rec.servings} حصة`,
        macros: {
          calories: Number(rec.macros.calories)||0,
          protein: Number(rec.macros.protein_g)||0,
          carbs:   Number(rec.macros.carbs_g)||0,
          fats:    Number(rec.macros.fat_g)||0
        },
        ingredients: rec.ingredients.map(s=>({ name: s, quantity: "" })),
        preparation: rec.steps.map(s=>({ title: "", instruction: s })),
        _servingsNum: Number(rec.servings)||1
      };
    }

    // ===== Nutrition renderers =====
    function renderNutritionFacts(m, servingsNum){
      nfServingsText.textContent = `عدد الحصص: ${servingsNum}`;
      nfServingSize.textContent  = `حجم الحصة: —`; // مجهول من المصدر؛ يمكن لاحقًا إضافته إن توفر
      nfCalories.textContent     = Math.round(m.calories);
      nfFat.textContent          = `${Math.round(m.fats)} جم`;
      nfCarbs.textContent        = `${Math.round(m.carbs)} جم`;
      nfProtein.textContent      = `${Math.round(m.protein)} جم`;
    }

    // Traffic light classification (تقريبية للاستخدام البصري فقط)
    function tlClass(val, low, high){ return val <= low ? "tl-low" : (val >= high ? "tl-high" : "tl-med"); }
    function renderTrafficLights(m){
      // حدود تقريبية لكل حصة
      const fatClass   = tlClass(m.fats, 10, 20);
      const carbsClass = tlClass(m.carbs, 30, 60);
      const protClass  = tlClass(m.protein, 15, 30);
      const pills = [
        { name:"الطاقة", grams:`${Math.round(m.calories)} kcal`, class:"tl-med", flag:"—" },
        { name:"دهون", grams:`${Math.round(m.fats)}g`, class:fatClass,   flag: fatClass==="tl-low"?"LOW":(fatClass==="tl-high"?"HIGH":"MED") },
        { name:"كربوهيدرات", grams:`${Math.round(m.carbs)}g`, class:carbsClass, flag: carbsClass==="tl-low"?"LOW":(carbsClass==="tl-high"?"HIGH":"MED") },
        { name:"بروتين", grams:`${Math.round(m.protein)}g`, class:protClass, flag: protClass==="tl-low"?"LOW":(protClass==="tl-high"?"HIGH":"MED") },
      ];
      tlWrap.innerHTML = pills.map(p=>`
        <div class="tl-pill ${p.class}">
          <span class="name">${p.name}</span>
          <span class="grams">${p.grams}</span>
          <span class="flag">${p.flag}</span>
        </div>
      `).join("");
    }

    function renderRecipe(data){
      // Top meta
      recipeTitle.textContent = data.title;
      timeValue.textContent   = data.time;
      servingsValue.textContent = data.servings;

      // Macros circle + chips
      caloriesValue.textContent = data.macros.calories;
      proteinValue.textContent  = `${data.macros.protein} جم`;
      carbsValue.textContent    = `${data.macros.carbs} جم`;
      fatsValue.textContent     = `${data.macros.fats} جم`;

      // Nutrition blocks
      renderNutritionFacts(data.macros, data._servingsNum);
      renderTrafficLights(data.macros);

      // Ingredients
      ingredientsList.innerHTML = "";
      data.ingredients.forEach(ing=>{
        const li=document.createElement('li');
        li.innerHTML = `<span class="font-bold text-gray-800">${ing.name}</span>${ing.quantity?` <span class="text-gray-500 text-sm mr-2">(${ing.quantity})</span>`:""}`;
        ingredientsList.appendChild(li);
      });

      // Steps
      preparationSteps.innerHTML = "";
      data.preparation.forEach(step=>{
        const div=document.createElement('div');
        div.className="prep-step";
        div.innerHTML = `<h4 class="step-title">${step.title || "الخطوة"}</h4><p class="step-text">${step.instruction}</p>`;
        preparationSteps.appendChild(div);
      });

      rawJson.textContent = JSON.stringify(data, null, 2);
      recipeOutput.classList.remove('hidden');
      setTimeout(()=>window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}),120);
    }

    async function requestRecipe(payload){
      const r = await fetch(API_ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok || !data.ok) throw new Error(data?.error || `تعذر الاتصال (${r.status})`);
      return data; // { ok:true, recipe, model }
    }

    async function generate(){
      clearOut(); err(""); show("جاري التوليد ...");
      generateBtn.disabled=true; loadingIndicator.classList.remove('hidden');
      generateBtn.innerHTML = '<div class="loader ml-2"></div> جارٍ التوليد...';

      const allergies=[];
      if (commonAllergyEl.value) allergies.push(commonAllergyEl.value);
      if (customAllergyEl.value.trim()) allergies.push(customAllergyEl.value.trim());

      const payload = {
        mealType: mealTypeEl.value,
        cuisine: cuisineEl.value,
        dietType: dietTypeEl.value,
        caloriesTarget: Number(calorieTargetEl.value)||500,
        allergies, focus: (focusEl.value||"").trim(), lang:"ar"
      };

      try{
        const data = await requestRecipe(payload);
        show(`تم التوليد — الموديل: ${data.model||"غير محدد"}`);
        renderRecipe(mapServerToView(data.recipe));
      }catch(e){
        err(e.message||"حدث خطأ غير متوقع"); show("", true);
      }finally{
        generateBtn.disabled=false; loadingIndicator.classList.add('hidden'); generateBtn.textContent='توليد الوصفة الآن';
      }
    }

    document.getElementById('generateBtn').addEventListener('click', async ()=>{
      const v=Number(calorieTargetEl.value||0);
      if(!v || v<100 || v>2000){ err("يرجى إدخال قيمة سعرات حرارية صالحة بين 100 و 2000."); return; }
      await generate();
    });
  </script>
</body>
</html>
