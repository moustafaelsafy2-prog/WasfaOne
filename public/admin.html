<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم — WasfaOne Admin</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Font (Inter) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Feather Icons for potential future use, though we embed SVGs in JS -->
  <script src="https://unpkg.com/feather-icons"></script>

  <style>
    body {
        font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, 
        Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", 
        "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        background: #f8fafc;
        color: #0f172a;
        line-height: 1.5;
    }
    .container {
        max-width: 1100px;
        margin: 40px auto;
        padding: 0 16px;
    }
    .page-title {
        font-size: clamp(20px, 3.5vw, 30px);
        font-weight: 800;
        letter-spacing: -0.02em;
        display: flex;
        align-items: center;
        gap: .6rem;
    }
    .sub {
        color: #64748b;
        font-weight: 500;
        font-size: 14px;
    }
    .card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgb(16 24 40 / 4%);
    }
    .card-header {
        padding: 14px 16px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .card-title {
        font-weight: 700;
        font-size: 16px;
    }
    .card-body {
        padding: 16px;
    }
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .5rem;
        padding: 10px 14px;
        border-radius: 10px;
        font-weight: 700;
        border: 1px solid #e2e8f0;
        background: white;
        transition: .2s ease;
        cursor: pointer;
    }
    .btn:hover { background: #f8fafc; }
    .btn.primary {
        background: #ef4444;
        border-color: #ef4444;
        color: white;
    }
    .btn.primary:hover { background: #dc2626; border-color: #dc2626; }
    .btn.ghost { background: transparent; }
    .btn.icon {
        width: 36px; height: 36px; padding: 0;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 10px;
    }
    .badge {
        display: inline-flex; align-items: center; gap: .4rem;
        padding: 6px 10px; border-radius: 999px; font-size: 12px;
        border: 1px solid #e2e8f0; background: #f8fafc; color: #0f172a;
        font-weight: 700;
    }
    .tabs { display: flex; gap: .5rem; flex-wrap: wrap; }
    .tabs .tab-btn {
        padding: 10px 14px;
        border-radius: 10px;
        background: white;
        border: 1px solid #e2e8f0;
        font-weight: 700;
        cursor: pointer;
    }
    .tabs .tab-btn.active {
        background: #ef4444; color: white; border-color: #ef4444;
    }
    .tabs-section { display: none; }
    .tabs-section.active { display: block; }

    .table {
        width: 100%;
        border-collapse: collapse;
    }
    .table th, .table td {
        border-bottom: 1px solid #e2e8f0;
        padding: 10px;
        text-align: start;
        font-size: 14px;
    }
    .table th { color: #475569; font-weight: 800; background: #f8fafc; }
    .muted { color: #64748b; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hint { color: #475569; font-size: 12px; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .row4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    @media (max-width: 900px) { .row, .row3, .row4 { grid-template-columns: 1fr; } }

    .input, .select, .textarea {
        width: 100%;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        transition: .2s ease;
    }
    .textarea { min-height: 90px; }
    .input:focus, .select:focus, .textarea:focus {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, .15)
    }

    .danger { color: #b91c1c; }
    .success { color: #16a34a; }
    .warn { color: #d97706; }

    .toolbar { display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; }
    .toolbar .search {
        min-width: 200px;
    }

    .section-title {
        display: flex; align-items: center; justify-content: space-between;
        gap: .5rem; font-size: 15px; font-weight: 800; margin: 10px 0;
    }

    .small {
        font-size: 12px; color: #475569;
    }

    .code {
        padding: 8px 10px; background: #0f172a; color: white; border-radius: 8px;
        font-size: 12px; overflow: auto; direction: ltr; text-align: left;
    }

    .kbd {
        background: #f1f5f9; border: 1px solid #e2e8f0; padding: 2px 6px; border-radius: 6px;
        font-size: 12px; font-weight: 700;
    }

    .divider { height: 1px; background: #e2e8f0; margin: 10px 0; }

    /* Modal */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(15,23,42,.5); display: none;
        align-items: center; justify-content: center; z-index: 50;
    }
    .modal-overlay.active { display: flex; }
    .modal {
        background: white; border: 1px solid #e2e8f0; border-radius: 12px; 
        box-shadow: 0 10px 30px rgba(0,0,0,.15);
        width: min(720px, 95vw);
    }
    .modal header, .modal footer { padding: 14px 16px; }
    .modal header { font-weight: 800; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; }
    .modal footer { border-top: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: end; gap: .5rem; }
    .modal .body { padding: 14px 16px; max-height: 60vh; overflow: auto; }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-title">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M7 7h10v10H7z"/></svg>
      لوحة التحكم — WasfaOne
    </div>
    <div class="sub">إدارة المستخدمين والإعدادات العامة.</div>

    <div class="card" style="margin-top: 16px;">
      <div class="card-header">
        <div class="card-title">الأقسام</div>
        <div class="tabs" id="tabsNav">
          <button class="tab-btn active" data-tab="tabUsers">المستخدمون</button>
          <button class="tab-btn" data-tab="tabSettings">الإعدادات</button>
          <button class="tab-btn" data-tab="tabAbout">حول الأداة</button>
        </div>
      </div>
      <div class="card-body">
        <section id="tabUsers" class="tabs-section active"></section>
        <section id="tabSettings" class="tabs-section"></section>
        <section id="tabAbout" class="tabs-section"></section>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalRoot" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <div id="modalTitle">Title</div>
        <button id="modalClose" class="btn icon" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </header>
      <div id="modalBody" class="body"></div>
      <footer>
        <div id="modalHint" class="hint" style="margin-inline-end:auto;"></div>
        <button id="modalCancel" class="btn">إلغاء</button>
        <button id="modalConfirm" class="btn primary">تأكيد</button>
      </footer>
    </div>
  </div>

  <script>
    // ===== Tabs =====
    const tabsNav = document.getElementById('tabsNav');
    const tabButtons = Array.from(tabsNav.querySelectorAll('button[data-tab]'));
    const tabSections = Array.from(document.querySelectorAll('.tabs-section'));
    function activateTab(id){
      tabButtons.forEach(b=> b.classList.toggle('active', b.dataset.tab===id));
      tabSections.forEach(s=> s.classList.toggle('active', s.id===id));
    }
    tabsNav.addEventListener('click',(e)=>{
      const btn = e.target.closest('button[data-tab]'); if(!btn) return; activateTab(btn.dataset.tab);
    });

    // ===== Admin key =====
    const ADMIN_KEY_STORAGE='wasfa_admin_key';
    let ADMIN_KEY = localStorage.getItem(ADMIN_KEY_STORAGE)||'';
    async function promptAdminKey(){
      if(!ADMIN_KEY){
        ADMIN_KEY = prompt('أدخل كلمة مرور الأدمن:');
        if(!ADMIN_KEY) throw new Error('admin_key_required');
        localStorage.setItem(ADMIN_KEY_STORAGE, ADMIN_KEY);
      }
    }

    // ===== Helpers =====
    const rowInputClass = "block w-full text-sm bg-white rounded-md border border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500 px-2 py-2 disabled:bg-slate-50 disabled:text-slate-500 disabled:cursor-not-allowed";
    const inputClass = "block w-full rounded-md border-slate-300 text-sm";
    const textareaClass = inputClass + " min-h-[90px]";

    function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
    function el(tag, attrs={}, children=[]){const e=document.createElement(tag);Object.entries(attrs).forEach(([k,v])=>{if(k==='class') e.className=v; else if(k==='text') e.textContent=v; else if(k==='html') e.innerHTML=v; else e.setAttribute(k,v)});children.forEach(c=>e.appendChild(c));return e;}
    async function api(path, method='GET', body){
      await promptAdminKey();
      const res = await fetch('/.netlify/functions/'+path,{method, headers:{'content-type':'application/json','x-admin-key':ADMIN_KEY},body: body? JSON.stringify(body): undefined});
      if(res.status===401){ localStorage.removeItem(ADMIN_KEY_STORAGE); ADMIN_KEY=''; throw new Error('unauthorized'); }
      let data={}; try{ data=await res.json(); }catch(_){}
      if(!res.ok || data.ok===false){ throw new Error(data.error||('request_failed_'+res.status)); }
      return data;
    }

    // ===== Modal system =====
    const modalRoot = document.getElementById('modalRoot');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalHint = document.getElementById('modalHint');
    const modalConfirm = document.getElementById('modalConfirm');
    const modalCancel = document.getElementById('modalCancel');
    const modalClose = document.getElementById('modalClose');
    let modalCleanup = null, modalConfirmHandler = null;

    function openModal({title, node, hint="", confirmText="تأكيد", onConfirm}){
      modalTitle.textContent = title;
      modalBody.innerHTML = ""; modalBody.appendChild(node);
      modalHint.textContent = hint;
      modalConfirm.textContent = confirmText;
      modalRoot.classList.add('active');
      modalConfirmHandler = onConfirm || null;
    }
    function closeModal(){
      modalRoot.classList.remove('active');
      modalBody.innerHTML = "";
      modalHint.textContent = "";
      modalConfirmHandler = null;
      if(typeof modalCleanup === 'function'){ try{ modalCleanup(); }catch(e){} }
      modalCleanup = null;
    }
    modalCancel.addEventListener('click', closeModal);
    modalClose.addEventListener('click', closeModal);
    modalRoot.addEventListener('click',(e)=>{ if(e.target===modalRoot) closeModal(); });
    modalConfirm.addEventListener('click', async ()=>{
      if(!modalConfirmHandler) return closeModal();
      try{
        const ok = await modalConfirmHandler();
        if(ok!==false) closeModal();
      }catch(e){
        alert('فشل التنفيذ: '+(e.message||e));
      }
    });

    // ===== Users Tab =====
    const tabUsers = document.getElementById('tabUsers');
    const tabSettings = document.getElementById('tabSettings');
    const tabAbout = document.getElementById('tabAbout');

    async function loadUsers(){
      const box = el('div',{},[
        el('div',{class:'toolbar', style:'margin-bottom:10px;'},[
          el('input',{class:'input search', placeholder:'بحث بالبريد..', id:'usersSearch'}),
          el('button',{class:'btn', id:'btnReloadUsers'},[
            el('span',{text:'تحديث القائمة'})
          ]),
          el('span',{class:'badge'},[
            el('svg',{width:'14',height:'14',viewBox:'0 0 24 24',fill:'none',stroke:'currentColor','stroke-width':'2',style:'margin-inline-end:4px;'},[
              el('path',{d:'M3 12h18M12 3v18'})
            ]),
            el('span',{text:'إدارة المستخدمين'})
          ])
        ]),
        el('div',{id:'usersTableWrap'})
      ]);
      tabUsers.innerHTML = ""; tabUsers.appendChild(box);

      async function render(){
        const data = await api('adminUsers','GET');
        const list = Array.isArray(data.users)? data.users: [];
        const q = (document.getElementById('usersSearch').value||'').trim().toLowerCase();
        const filtered = q? list.filter(u => (u.email||'').toLowerCase().includes(q)): list;

        const table = el('table', {class:'table'}, []);

        const thead = el('thead',{},[
          el('tr',{},[
            el('th',{text:'البريد'}), el('th',{text:'مفعّل؟'}), el('th',{text:'صلاحية؟'}),
            el('th',{text:'بداية'}), el('th',{text:'نهاية'}),
            el('th',{text:'جهاز/بصمة'}), el('th',{text:'ملاحظات قفل'}), el('th',{text:'إجراءات'})
          ])
        ]);
        const tbody = el('tbody',{},[]);
        table.appendChild(thead); table.appendChild(tbody);

        filtered.forEach(u=>{
          const tr = el('tr',{},[
            el('td',{},[ el('div',{text:u.email||''}), el('div',{class:'small muted mono', text:(u.name||'')}) ]),
            el('td',{},[ el('span',{class:'badge'},[ el('span',{text: u.enabled? 'نعم':'لا'}) ]) ]),
            el('td',{},[ el('span',{class:'badge'},[ el('span',{text: (u.role||'user') }) ]) ]),
            el('td',{class:'mono muted',text: u.start_date||''}),
            el('td',{class:'mono muted',text: u.end_date||''}),
            el('td',{class:'mono muted',text: (u.device_fingerprint||'')}),
            el('td',{class:'mono muted',text: (u.lock_reason||'')}),
            el('td',{},[
              el('div',{class:'toolbar'},[
                el('button',{class:'btn',onclick:()=>openEditUser(u)},[ el('span',{text:'تعديل'}) ]),
                el('button',{class:'btn',onclick:()=>resetLock(u)},[ el('span',{text:'إلغاء الحظر'}) ]),
                el('button',{class:'btn danger',onclick:()=>removeUser(u)},[ el('span',{text:'حذف'}) ]),
              ])
            ])
          ]);
          tbody.appendChild(tr);
        });

        const wrap = document.getElementById('usersTableWrap');
        wrap.innerHTML = ""; wrap.appendChild(table);
      }

      document.getElementById('btnReloadUsers').addEventListener('click', render);
      document.getElementById('usersSearch').addEventListener('input', render);

      // Actions
      async function resetLock(u){
        if(!confirm('تأكيد إلغاء القفل لهذا المستخدم؟')) return;
        await api('adminUsers','POST', { action:'reset_lock', email: u.email });
        await render();
      }
      async function removeUser(u){
        if(!confirm('تأكيد حذف هذا المستخدم؟')) return;
        await api('adminUsers','DELETE', { email: u.email });
        await render();
      }

      function userForm(u){
        const row = el('div',{class:'row'},[
          el('div',{},[
            el('label',{class:'small',text:'البريد'}), 
            el('input',{class:'input', id:'email', value:u.email||'', placeholder:'user@example.com'})
          ]),
          el('div',{},[
            el('label',{class:'small',text:'الاسم (اختياري)'}),
            el('input',{class:'input', id:'name', value:u.name||'', placeholder:'اسم المستخدم'})
          ]),
          el('div',{},[
            el('label',{class:'small',text:'كلمة المرور'}),
            el('input',{class:'input', id:'pass', value:u.pass||'', placeholder:'••••••••'})
          ]),
          el('div',{},[
            el('label',{class:'small',text:'الدور'}),
            (()=>{
              const sel = el('select',{class:'select',id:'role'},[
                el('option',{value:'user',text:'user'}),
                el('option',{value:'admin',text:'admin'})
              ]);
              sel.value = (u.role||'user');
              return sel;
            })(),
          ]),
          el('div',{},[
            el('label',{class:'small',text:'مفعّل؟'}),
            (()=>{
              const sel = el('select',{class:'select',id:'enabled'},[
                el('option',{value:'true',text:'true'}),
                el('option',{value:'false',text:'false'})
              ]);
              sel.value = String(!!u.enabled);
              return sel;
            })(),
          ]),
          el('div',{},[
            el('label',{class:'small',text:'البداية YYYY-MM-DD'}),
            el('input',{class:'input mono',id:'start_date',value:u.start_date||'', placeholder:'2025-01-01'})
          ]),
          el('div',{},[
            el('label',{class:'small',text:'النهاية YYYY-MM-DD'}),
            el('input',{class:'input mono',id:'end_date',value:u.end_date||'', placeholder:'2025-12-31'})
          ]),
          el('div',{},[
            el('label',{class:'small',text:'بصمة الجهاز (اختياري)'}),
            el('input',{class:'input mono',id:'device_fingerprint',value:u.device_fingerprint||'', placeholder:'optional'})
          ]),
          el('div',{},[
            el('label',{class:'small',text:'ملاحظات القفل (اختياري)'}),
            el('input',{class:'input',id:'lock_reason',value:u.lock_reason||'', placeholder:'notes'})
          ]),
        ]);
        const foot = el('div',{class:'row'},[
          el('div',{},[
            el('label',{class:'small',text:'تحديث إذا موجود؟ (upsert)'}),
            (()=>{
              const c = el('input',{type:'checkbox',id:'upsert'});
              if(u.email) c.checked = true;
              return el('label',{},[ c, el('span',{text:'  تفعيل التحديث إذا كان البريد موجودًا'}) ]);
            })()
          ]),
          el('div',{},[
            el('button',{class:'btn primary', id:'btnUserSave'},[ el('span',{text:'حفظ'}) ])
          ])
        ]);

        const root = el('div',{},[
          row, el('div',{class:'divider'}), foot
        ]);

        setTimeout(()=>{
          document.getElementById('email').focus();
        },50);

        root.querySelector('#btnUserSave').addEventListener('click', async ()=>{
          const fd = {
            email: (document.getElementById('email').value||'').trim().toLowerCase(),
            name: (document.getElementById('name').value||'').trim(),
            pass: (document.getElementById('pass').value||'').trim(),
            role: (document.getElementById('role').value||'user'),
            enabled: document.getElementById('enabled').value==='true',
            start_date: (document.getElementById('start_date').value||'').trim()||null,
            end_date: (document.getElementById('end_date').value||'').trim()||null,
            device_fingerprint: (document.getElementById('device_fingerprint').value||'').trim()||null,
            lock_reason: (document.getElementById('lock_reason').value||'').trim()||null
          };

          if(!fd.email){ alert('أدخل البريد'); return; }
          if(!fd.pass){ alert('أدخل كلمة المرور'); return; }

          try{
            await api('adminUsers','POST',{ action:'upsert', user: fd, upsert: true });
            alert('تم الحفظ');
            closeModal();
            await render();
          }catch(e){
            alert('فشل الحفظ: '+(e.message||e));
          }
        });

        return root;
      }

      async function openEditUser(u={}){
        openModal({ 
          title: u.email? ('تعديل مستخدم — '+u.email): 'مستخدم جديد',
          node: userForm(u),
          hint: 'تعديل البيانات الأساسية، صلاحية الحساب، وفترة الاشتراك (اختياري).',
          confirmText: 'إغلاق'
        });
      }

      openEditUser(); // open blank form for new user by default
      await render();
    }

    // ===== Settings Tab =====
    async function loadSettings(){
      const data = await api('adminSettings','GET');
      const s = data.settings || {};
      const root = el('div',{},[]);

      function row2(label, inputNode, hint=''){
        return el('div',{class:'row'},[
          el('div',{},[ el('div',{class:'small',text:label}), inputNode ]),
          el('div',{},[ el('div',{class:'hint',text:hint}) ])
        ]);
      }

      const langSel = (()=>{
        const sel = el('select',{class:'select', id:'defaultLang'},[
          el('option',{value:'ar',text:'ar'}),
          el('option',{value:'en',text:'en'}),
        ]);
        sel.value = (s.default_lang || 'ar');
        return sel;
      })();

      const phone = el('input',{class:'input', id:'contactPhone', value: s.contact?.phone || '', placeholder:'+971...'});
      const whatsapp = el('input',{class:'input', id:'contactWhatsApp', value: s.contact?.whatsapp || '', placeholder:'+971...'});
      const email = el('input',{class:'input', id:'contactEmail', value: s.contact?.email || '', placeholder:'support@example.com'});
      const instagram = el('input',{class:'input', id:'contactInst', value: s.contact?.instagram || '', placeholder:'https://instagram.com/...'});

      const logo = el('input',{class:'input', id:'logoUrl', value: s.brand?.logo?.url || '', placeholder:'https://...'});
      const logoAltAr = el('input',{class:'input', id:'logoAltAr', value: s.brand?.logo?.alt_ar || '', placeholder:'شعار'});
      const logoAltEn = el('input',{class:'input', id:'logoAltEn', value: s.brand?.logo?.alt_en || '', placeholder:'Logo'});

      const hero = el('input',{class:'input', id:'heroUrl', value: s.brand?.hero?.url || '', placeholder:'https://...'});
      const heroAltAr = el('input',{class:'input', id:'heroAltAr', value: s.brand?.hero?.alt_ar || '', placeholder:'صورة رئيسية'});
      const heroAltEn = el('input',{class:'input', id:'heroAltEn', value: s.brand?.hero?.alt_en || '', placeholder:'Hero'});

      const siteTitleAr = el('input',{class:'input', id:'titleAr', value: s.text?.title_ar || '', placeholder:'عنوان الموقع (AR)'});
      const siteTitleEn = el('input',{class:'input', id:'titleEn', value: s.text?.title_en || '', placeholder:'Site title (EN)'});
      const siteDescAr = el('textarea',{class:'textarea', id:'descAr'},[document.createTextNode(s.text?.desc_ar || '')]);
      const siteDescEn = el('textarea',{class:'textarea', id:'descEn'},[document.createTextNode(s.text?.desc_en || '')]);

      const legalPrivacyAr = el('textarea',{class:'textarea', id:'privacyAr'},[document.createTextNode(s.legal?.privacy_ar || '')]);
      const legalPrivacyEn = el('textarea',{class:'textarea', id:'privacyEn'},[document.createTextNode(s.legal?.privacy_en || '')]);

      const submitBtn = el('button',{class:'btn primary', id:'btnSaveSettings'},[ el('span',{text:'حفظ الإعدادات'}) ]);

      root.appendChild(row2('اللغة الافتراضية', langSel, 'ar/en'));
      root.appendChild(row2('الهاتف', phone));
      root.appendChild(row2('واتساب', whatsapp));
      root.appendChild(row2('البريد', email));
      root.appendChild(row2('انستجرام', instagram));

      root.appendChild(el('div',{class:'section-title'},[ el('span',{text:'العلامة — logo & hero'}) ]));
      root.appendChild(row2('Logo URL', logo));
      root.appendChild(row2('Logo ALT AR', logoAltAr));
      root.appendChild(row2('Logo ALT EN', logoAltEn));

      root.appendChild(row2('Hero URL', hero));
      root.appendChild(row2('Hero ALT AR', heroAltAr));
      root.appendChild(row2('Hero ALT EN', heroAltEn));

      root.appendChild(el('div',{class:'section-title'},[ el('span',{text:'النصوص'}) ]));
      root.appendChild(row2('Title (AR)', siteTitleAr));
      root.appendChild(row2('Title (EN)', siteTitleEn));
      root.appendChild(row2('Description (AR)', siteDescAr));
      root.appendChild(row2('Description (EN)', siteDescEn));

      root.appendChild(el('div',{class:'section-title'},[ el('span',{text:'سياسة الخصوصية'}) ]));
      root.appendChild(row2('Privacy (AR)', legalPrivacyAr));
      root.appendChild(row2('Privacy (EN)', legalPrivacyEn));

      root.appendChild(el('div',{class:'divider'}));
      root.appendChild(submitBtn);

      tabSettings.innerHTML = ""; tabSettings.appendChild(root);

      submitBtn.addEventListener('click', async ()=>{
        const payload = {
          default_lang: document.getElementById('defaultLang').value || 'ar',
          contact: {
            phone: document.getElementById('contactPhone').value || '',
            whatsapp: document.getElementById('contactWhatsApp').value || '',
            email: document.getElementById('contactEmail').value || '',
            instagram: document.getElementById('contactInst').value || '',
          },
          brand: {
            logo: {
              url: document.getElementById('logoUrl').value || '',
              alt_ar: document.getElementById('logoAltAr').value || '',
              alt_en: document.getElementById('logoAltEn').value || '',
            },
            hero: {
              url: document.getElementById('heroUrl').value || '',
              alt_ar: document.getElementById('heroAltAr').value || '',
              alt_en: document.getElementById('heroAltEn').value || '',
            },
          },
          text: {
            title_ar: document.getElementById('titleAr').value || '',
            title_en: document.getElementById('titleEn').value || '',
            desc_ar: document.getElementById('descAr').value || '',
            desc_en: document.getElementById('descEn').value || '',
          },
          legal: {
            privacy_ar: document.getElementById('privacyAr').value || '',
            privacy_en: document.getElementById('privacyEn').value || '',
          }
        };

        try{
          await api('adminSettings','POST', { settings: payload });
          alert('تم حفظ الإعدادات وتحديث نسخة public');
        }catch(e){
          alert('فشل حفظ الإعدادات: '+(e.message||e));
        }
      });
    }

    // ===== About Tab =====
    function loadAbout(){
      const root = el('div',{},[
        el('p',{class:'small', html: 'هذه اللوحة لإدارة المستخدمين والإعدادات. تأكد من ضبط متغير البيئة <span class="kbd">ADMIN_PASSWORD</span> في Netlify.'}),
        el('div',{class:'divider'}),
        el('div',{class:'code'},[ document.createTextNode(`Headers: { "x-admin-key": "<ADMIN_PASSWORD>" }`) ]),
        el('p',{class:'hint', text:'الأمن: لا يتم ربط دخول الأدمن بأي جهاز؛ الحماية تعتمد على كلمة الأدمن (متغير بيئة).' })
      ]);
      tabAbout.innerHTML = ""; tabAbout.appendChild(root);
    }

    // Initialize
    loadUsers();
    loadSettings();
    loadAbout();
  </script>
</body>
</html>
