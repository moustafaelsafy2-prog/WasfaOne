<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تسجيل الدخول • Wasfa</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --brand:#ef4444;
      --brand-dark:#dc2626;
      --ink:#0f172a;
      --muted:#475569;
      --soft-bg:#f7f7f9;
      --line:#e5e7eb;
    }
    html{ scroll-behavior:smooth }
    body{
      font-family:'Cairo', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:var(--ink); background:var(--soft-bg);
    }

    .auth-hero{
      position:relative; min-height:100vh; display:grid; place-items:center; overflow:hidden;
    }
    .auth-hero::before{
      content:""; position:absolute; inset:0;
      background-image:url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=2070&auto=format&fit=crop');
      background-size:cover; background-position:center;
      transform:scale(1.05);
      filter:saturate(1.05) contrast(1.05);
    }
    .auth-hero::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55));
      backdrop-filter: blur(2px);
    }

    .brand-title{
      background:linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }

    .pro-card{
      position:relative;
      background:linear-gradient(180deg, #fff, #fafafa);
      border:1px solid var(--line);
      border-radius:28px;
      box-shadow:0 25px 50px -12px rgba(0,0,0,.12);
      transition:transform .25s, box-shadow .25s;
    }
    .pro-card:hover{ transform:translateY(-4px); box-shadow:0 30px 60px -20px rgba(0,0,0,.18) }

    .auth-wrap{ width:100%; max-width:480px; padding:24px }
    .auth-card{ padding:28px }

    .field{ position:relative }
    .field input{
      width:100%; min-height:52px; padding:0 48px 0 14px;
      border:1px solid var(--line); border-radius:16px; background:#fcfdff;
      transition:.2s;
    }
    .field input:focus{
      outline:none; border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(239,68,68,.12);
      background:#fff;
    }
    .field .icon{
      position:absolute; inset-block:0; inset-inline-end:0;
      width:44px; display:grid; place-items:center; color:#9aa4b2; pointer-events:none;
    }
    .field .action{
      position:absolute; inset-block:0; inset-inline-start:0;
      display:grid; place-items:center; width:44px; color:#6b7280;
    }

    .cta-button{
      position:relative; overflow:hidden;
      display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      width:100%; border-radius:14px; padding:14px 24px; font-weight:800;
      color:#fff; background:var(--brand);
      box-shadow:0 6px 18px rgba(239,68,68,.28);
      transition:transform .2s, box-shadow .2s, background .2s;
    }
    .cta-button:hover{ background:var(--brand-dark); transform:translateY(-1px); box-shadow:0 10px 26px rgba(239,68,68,.34) }
    .cta-button::after{
      content:""; position:absolute; inset:-2px; border-radius:16px; opacity:0;
      background:radial-gradient(120px 120px at var(--mx,50%) var(--my,50%), rgba(255,255,255,.2), transparent 60%);
      transition:opacity .2s; pointer-events:none;
    }
    .cta-button.is-hovering::after{ opacity:1 }
    .ripple{ position:absolute; border-radius:9999px; transform:translate(-50%,-50%); pointer-events:none; animation:ripple 600ms ease-out forwards; background:rgba(255,255,255,.35) }
    @keyframes ripple{ from{ width:0; height:0; opacity:.6 } to{ width:340px; height:340px; opacity:0 } }

    .spinner{
      border:2px solid #fff; border-top-color:transparent; border-radius:999px;
      width:20px; height:20px; animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .mini-header{ display:flex; align-items:center; gap:.75rem; margin-bottom:10px }
    .mini-badge{
      display:inline-grid; place-items:center; width:42px; height:42px;
      border-radius:12px; background:rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.25);
      color:var(--brand);
    }
    .link{ color:var(--brand); font-weight:700 }
    .link:hover{ color:var(--brand-dark); text-decoration:underline }
    .auth-footer{ color:#e5e7eb; text-shadow:0 1px 2px rgba(0,0,0,.35) }
  </style>
</head>
<body>

  <section class="auth-hero">
    <div class="relative z-10 auth-wrap">
      <div class="pro-card auth-card">
        <header class="text-center mb-6">
          <div class="inline-flex items-center gap-3">
            <img id="login-logo" class="h-14 w-14 rounded-2xl shadow-md ring-1 ring-white/40" alt="Logo" src="https://placehold.co/60x60/ef4444/ffffff?text=W" />
            <h1 class="text-4xl md:text-5xl font-black brand-title leading-none">Wasfa</h1>
          </div>
          <p class="text-[var(--muted)] mt-2">مرحبًا بك — من فضلك سجّل دخولك للمتابعة</p>
        </header>

        <div class="mini-header">
          <span class="mini-badge"><i data-lucide="lock" class="w-5 h-5"></i></span>
          <div>
            <div class="font-extrabold">تسجيل الدخول</div>
            <div class="text-xs text-[var(--muted)]">الوصول إلى لوحة Wasfa محمي</div>
          </div>
        </div>

        <form id="login-form" class="space-y-5 mt-3">
          <div class="field">
            <span class="icon"><i data-lucide="mail" class="w-5 h-5"></i></span>
            <input id="email" class="text-[15px]" placeholder="البريد الإلكتروني" type="email" required />
          </div>

          <div class="field">
            <span class="icon"><i data-lucide="lock-keyhole" class="w-5 h-5"></i></span>
            <input id="password" class="text-[15px]" placeholder="كلمة المرور" type="password" required />
            <button type="button" id="toggle-password" class="action" aria-label="إظهار/إخفاء كلمة المرور">
              <i id="eye-icon" data-lucide="eye" class="w-5 h-5"></i>
              <i id="eye-slash-icon" data-lucide="eye-off" class="w-5 h-5 hidden"></i>
            </button>
          </div>

          <div class="flex items-center justify-between text-sm">
            <div class="flex items-center gap-2 text-[var(--muted)]">
              <i data-lucide="shield-check" class="w-4 h-4"></i>
              <span>جلسة آمنة</span>
            </div>
            <a href="https://wa.me/971502061209" target="_blank" rel="noopener" class="link">نسيت كلمة المرور؟</a>
          </div>

          <button id="login-button" class="cta-button" type="submit">
            <span id="button-text">دخول</span>
            <div id="button-spinner" class="spinner hidden"></div>
          </button>

          <div id="login-error" class="text-red-600 text-sm hidden pt-1 text-center"></div>
        </form>

        <div class="mt-6 text-center text-sm">
          <a href="privacy.html" class="text-[var(--muted)] hover:text-[var(--ink)] underline decoration-dotted">سياسة الخصوصية</a>
        </div>
      </div>

      <footer class="mt-6 text-center auth-footer text-sm">
        <span>&copy; 2024 Wasfa. جميع الحقوق محفوظة.</span>
      </footer>
    </div>
  </section>

  <!-- تحميل الأدوات العامة التي تثبّت wasfa_device_id وتوفّر wasfaLogout/saveSession -->
  <script src="/public/assets/app.js"></script>

  <script>
    // تهيئة الأيقونات
    lucide.createIcons();

    // تأثيرات زر الدخول (ضوء + Ripple)
    (function enhanceCTA(){
      const btn = document.getElementById('login-button');
      if (!btn) return;
      btn.addEventListener('mousemove', (e)=>{
        const r = btn.getBoundingClientRect();
        btn.style.setProperty('--mx', `${e.clientX - r.left}px`);
        btn.style.setProperty('--my', `${e.clientY - r.top}px`);
        btn.classList.add('is-hovering');
      });
      btn.addEventListener('mouseleave', ()=> btn.classList.remove('is-hovering'));
      btn.addEventListener('click', (e)=>{
        const r = btn.getBoundingClientRect();
        const circle = document.createElement('span');
        circle.className = 'ripple';
        circle.style.left = (e.clientX - r.left) + 'px';
        circle.style.top  = (e.clientY - r.top) + 'px';
        btn.appendChild(circle);
        setTimeout(()=> circle.remove(), 650);
      });
    })();

    // تبديل إظهار كلمة المرور
    (function bindTogglePassword(){
      const togglePassword = document.getElementById('toggle-password');
      const passwordInput  = document.getElementById('password');
      const eyeIcon        = document.getElementById('eye-icon');
      const eyeSlashIcon   = document.getElementById('eye-slash-icon');
      if (!togglePassword) return;
      togglePassword.addEventListener('click', function(){
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        eyeIcon.classList.toggle('hidden');
        eyeSlashIcon.classList.toggle('hidden');
      });
    })();

    // -------- Fingerprint --------
    async function computeFingerprintHash() {
      // تثبيت/قراءة device_id مرة واحدة
      const deviceId = (window.WasfaApp && window.WasfaApp.ensureDeviceId)
        ? window.WasfaApp.ensureDeviceId()
        : (function(){
            let id = localStorage.getItem('wasfa_device_id');
            if (!id) {
              id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));
              localStorage.setItem('wasfa_device_id', id);
            }
            return id;
          })();

      const parts = [
        deviceId,
        navigator.userAgent || '',
        navigator.language || '',
        (screen && screen.width) ? String(screen.width) : '',
        (screen && screen.height) ? String(screen.height) : '',
        (screen && screen.colorDepth) ? String(screen.colorDepth) : '',
        String(new Date().getTimezoneOffset()),
        navigator.platform || '',
        String(navigator.hardwareConcurrency || '')
      ].join('|');

      const enc = new TextEncoder().encode(parts);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // -------- Login Submit --------
    (function bindLogin(){
      const form   = document.getElementById('login-form');
      const email  = document.getElementById('email');
      const pass   = document.getElementById('password');
      const btn    = document.getElementById('login-button');
      const btnTxt = document.getElementById('button-text');
      const spin   = document.getElementById('button-spinner');
      const error  = document.getElementById('login-error');

      function setBusy(v){
        if (!btn) return;
        btn.disabled = v;
        if (spin) spin.classList.toggle('hidden', !v);
        if (btnTxt) btnTxt.textContent = v ? 'جاري تسجيل الدخول…' : 'دخول';
      }
      function setError(msg){
        if (!error) return;
        error.textContent = msg || '';
        error.classList.toggle('hidden', !msg);
      }

      if (!form) return;
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        setError('');
        setBusy(true);
        try{
          const device_fingerprint_hash = await computeFingerprintHash();

          const res = await fetch('/.netlify/functions/login', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({
              email: (email.value||'').trim(),
              password: pass.value || '',
              device_fingerprint_hash
            })
          });

          const out = await res.json().catch(()=>({ ok:false, message:'Bad JSON' }));
          if (!res.ok || !out || !out.ok){
            setError(out && out.message ? out.message : 'فشل تسجيل الدخول');
            return;
          }

          // حفظ الجلسة (واترك wasfa_device_id كما هو)
          if (window.WasfaApp && window.WasfaApp.saveSession){
            window.WasfaApp.saveSession({
              token: out.token,
              session_nonce: out.session_nonce,
              user: { email: out.email, name: out.name }
            });
          } else {
            localStorage.setItem('wasfa_token', out.token);
            localStorage.setItem('wasfa_session_nonce', out.session_nonce);
            localStorage.setItem('wasfa_user', JSON.stringify({ email: out.email, name: out.name }));
          }

          // انتقال للتطبيق
          window.location.href = '/app.html';
        } catch(err){
          console.error(err);
          setError('تعذّر إتمام العملية الآن. حاول لاحقًا.');
        } finally {
          setBusy(false);
        }
      });
    })();
  </script>
</body>
</html>
